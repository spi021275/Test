<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA sfruttando l'expertise di 51 anni, partnership certificate e soluzioni proprietarie (Spacebooking, Agrid Welcome/Bank).</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 3 - NUOVO -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generazione File</h3>
                            <p class="text-gray-600 mb-4">Trasforma l'Analisi Economica DSA in offerta commerciale, sintesi dati e file CRM pronti all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module (ORIGINAL CODE KEPT) -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Modulo 1 - Mantiene tutte le funzionalità originali</p>
            </div>
        </div>

        <!-- Space Wizard Module (ORIGINAL CODE KEPT) -->
        <div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Wizard Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Modulo 2 - Mantiene tutte le funzionalità originali</p>
            </div>
        </div>

        <!-- File Generator Module - NUOVO -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione File da Analisi Economica DSA</h2>
                <p class="text-gray-600 mb-8">Carica il file Excel "Analisi Economica" dal DSA e genera automaticamente offerta commerciale, sintesi dati e file CRM</p>
                
                <div id="fileGeneratorForm" class="space-y-8">
                    
                    <!-- Dati Base Progetto -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto</label>
                            <input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. PRJ-2024-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sales Manager VAR</label>
                            <input type="text" id="salesManager" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. Mario Rossi">
                        </div>
                    </div>

                    <!-- Upload Analisi Economica -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-green-300 border-dashed rounded-lg bg-green-50 hover:bg-green-100 cursor-pointer transition-colors">
                                <svg class="w-10 h-10 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span class="text-sm text-green-700 font-medium">Carica Analisi Economica DSA</span>
                                <span class="text-xs text-green-600 mt-1">.xlsx, .xlsm, .xls (max 10MB)</span>
                            </div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls">
                            
                            <!-- Uploaded File Display -->
                            <div id="uploadedAnalysisFile" class="mt-4 hidden">
                                <div class="flex items-center justify-between bg-green-100 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span id="analysisFileName" class="font-medium text-green-800"></span>
                                    </div>
                                    <button onclick="removeAnalysisFile()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Excel Data Preview -->
                            <div id="excelDataPreview" class="mt-4 hidden">
                                <h4 class="font-medium text-gray-800 mb-2">Anteprima Dati Estratti dal Foglio "Analisi Economica"</h4>
                                <div class="bg-white p-4 rounded-lg border max-h-60 overflow-y-auto">
                                    <div id="excelPreviewContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateFiles()" id="fileGenerateBtn" class="inline-flex items-center px-8 py-3 bg-green-600 text-white font-medium text-lg rounded-lg hover:bg-green-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Genera File
                        </button>
                    </div>
                </div>

                <!-- Generated Files Display -->
                <div id="generatedFiles" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">File Generati</h3>
                        <button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Nuova Generazione
                        </button>
                    </div>
                    
                    <div id="generatedFilesContent" class="bg-gray-50 p-6 rounded-lg">
                        <!-- Generated content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento specializzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Alimentato dall'expertise di 51 anni, 823M€ fatturato, 3.850 persone, partnership certificate e soluzioni proprietarie
        </p>
    </div>

    <script>
        // API Configuration
        const API_KEY = "AIzaSyDjlVWJIzGCa5CnXbj_nQEj1aG2aHlLwnQ";
        
        // State management
        let analysisFile = null;
        let extractedData = {};

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // File Generator Functions
        async function handleAnalysisUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.xlsx') && 
                !file.name.toLowerCase().endsWith('.xlsm') && 
                !file.name.toLowerCase().endsWith('.xls')) {
                alert('Seleziona solo file Excel (.xlsx, .xlsm o .xls)');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('Il file è troppo grande. Limite massimo: 10MB');
                return;
            }

            try {
                analysisFile = file;
                
                // Show file info
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
                
                // Process Excel file
                await processExcelFile(file);
                
            } catch (error) {
                console.error('Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        }

        async function processExcelFile(file) {
            try {
                const data = await readExcelFile(file);
                extractedData = extractKeyData(data);
                
                // Show preview
                displayExcelPreview(extractedData);
                
                // Enable generate button
                document.getElementById('fileGenerateBtn').disabled = false;
                
            } catch (error) {
                console.error('Errore nell\'elaborazione del file Excel:', error);
                alert('Errore nell\'elaborazione del file Excel: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { 
                            type: 'binary',
                            cellFormulas: false,
                            cellStyles: false,
                            sheetStubs: true
                        });
                        
                        const result = {};
                        workbook.SheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            result[sheetName] = XLSX.utils.sheet_to_json(sheet, { 
                                header: 1,
                                defval: '',
                                raw: false
                            });
                        });
                        
                        resolve(result);
                    } catch (error) {
                        reject(new Error(`Errore nel parsing del file Excel: ${error.message}`));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Errore nella lettura del file'));
                };
                
                reader.readAsBinaryString(file);
            });
        }

        function extractKeyData(excelData) {
            const extracted = {
                cliente: '',
                progetto: '',
                totaleOfferta: 0,
                margine: 0,
                componenti: [],
                righeComplete: [],
                headers: [],
                riepilogo: {},
                sheets: Object.keys(excelData),
                dataFound: false,
                numeroRighe: 0,
                numeroColonne: 0
            };

            // Cerca specificamente il foglio "Analisi Economica"
            const targetSheetNames = [
                'Analisi Economica',
                'analisi economica', 
                'ANALISI ECONOMICA',
                'Analisi_Economica',
                'AnalisiEconomica'
            ];

            let targetSheet = null;
            let sheetName = '';

            for (const name of targetSheetNames) {
                if (excelData[name]) {
                    targetSheet = excelData[name];
                    sheetName = name;
                    extracted.dataFound = true;
                    break;
                }
            }

            if (!targetSheet) {
                for (const name of Object.keys(excelData)) {
                    const lowerName = name.toLowerCase();
                    if (lowerName.includes('analisi') && lowerName.includes('economica')) {
                        targetSheet = excelData[name];
                        sheetName = name;
                        extracted.dataFound = true;
                        break;
                    }
                }
            }

            if (!targetSheet) {
                console.warn('Foglio "Analisi Economica" non trovato. Fogli disponibili:', Object.keys(excelData));
                return extracted;
            }

            extracted.numeroRighe = targetSheet.length;
            extracted.numeroColonne = Math.max(...targetSheet.map(row => row ? row.length : 0));

            // Estrai tutte le righe
            targetSheet.forEach((row, rowIndex) => {
                if (!row) return;
                
                const hasContent = row.some(cell => cell && cell.toString().trim());

                if (hasContent) {
                    const rigaCompleta = {
                        numeroRiga: rowIndex + 1,
                        valoriGrezzi: [],
                        dati: {}
                    };

                    row.forEach((cell, colIndex) => {
                        const valore = cell ? cell.toString().trim() : '';
                        rigaCompleta.valoriGrezzi.push(valore);
                        rigaCompleta.dati[`col_${colIndex + 1}`] = valore;
                    });

                    extracted.righeComplete.push(rigaCompleta);

                    // Analisi per componenti - esempio riga: 1 Auditorium Smart Room...
                    const primaColonna = rigaCompleta.valoriGrezzi[0] || '';
                    if (primaColonna && !isNaN(parseInt(primaColonna))) {
                        const componente = {
                            riga: rowIndex + 1,
                            numeroProgressivo: parseInt(primaColonna),
                            spazio: rigaCompleta.valoriGrezzi[1] || '',
                            tipologia: rigaCompleta.valoriGrezzi[2] || '',
                            categoria: rigaCompleta.valoriGrezzi[3] || '',
                            codice: '',
                            descrizione: '',
                            quantita: 0,
                            prezzoUnitario: 0,
                            prezzoTotale: 0,
                            costoUnitario: 0,
                            costoTotale: 0,
                            margineUnitario: 0,
                            margineTotale: 0,
                            valoriCompleti: rigaCompleta.valoriGrezzi
                        };

                        // Cerca dati nelle colonne successive
                        for (let i = 4; i < rigaCompleta.valoriGrezzi.length; i++) {
                            const valore = rigaCompleta.valoriGrezzi[i];
                            if (valore) {
                                // Codice prodotto (es. EB-L630U)
                                if (/^[A-Z0-9\-]{3,20}$/i.test(valore) && !componente.codice) {
                                    componente.codice = valore;
                                }
                                // Descrizione (es. "Proiettore laser, 6200 lumens")
                                else if (valore.length > 10 && valore.includes(' ') && !componente.descrizione) {
                                    componente.descrizione = valore;
                                }
                                // Numeri (qty, prezzi, costi)
                                else if (!isNaN(parseFloat(valore.replace(/[€\s\.,]/g, '').replace(',', '.')))) {
                                    const numero = parseFloat(valore.replace(/[€\s\.,]/g, '').replace(',', '.'));
                                    
                                    if (numero <=
