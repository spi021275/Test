<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA sfruttando l'expertise di 51 anni, partnership certificate e soluzioni proprietarie.</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 3 - UPDATED -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generazione File</h3>
                            <p class="text-gray-600 mb-4">Trasforma l'Analisi Economica DSA in offerta commerciale, sintesi dati e file CRM pronti all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module (EXISTING) -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Trasforma i tuoi appunti del meeting in un brief tecnico strutturato per il team DSA utilizzando l'expertise completa della BU (51 anni esperienza, 823M€ fatturato, 3.850 persone)</p>
                
                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 1 - Funzionalità esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- Space Wizard Module (EXISTING) -->
        <div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Wizard Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Configura la soluzione tecnologica ottimale per il tuo spazio con analisi AI automatica da foto/planimetrie o inserimento manuale</p>
                
                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 2 - Funzionalità esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- File Generator Module - UPDATED -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione File da Analisi Economica DSA</h2>
                <p class="text-gray-600 mb-8">Carica il file Excel "Analisi Economica" dal DSA e genera automaticamente offerta commerciale, sintesi dati e file CRM</p>
                
                <div id="fileGeneratorForm" class="space-y-8">
                    
                    <!-- Dati Base Progetto -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto</label>
                            <input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. PRJ-2024-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sales Manager VAR</label>
                            <input type="text" id="salesManager" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. Mario Rossi">
                        </div>
                    </div>

                    <!-- Upload Analisi Economica -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-green-300 border-dashed rounded-lg bg-green-50 hover:bg-green-100 cursor-pointer transition-colors">
                                <svg class="w-10 h-10 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span class="text-sm text-green-700 font-medium">Carica Analisi Economica DSA</span>
                                <span class="text-xs text-green-600 mt-1">.xlsx, .xlsm, .xls (max 10MB)</span>
                            </div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls" onchange="handleAnalysisUpload(event)">
                            
                            <!-- Uploaded File Display -->
                            <div id="uploadedAnalysisFile" class="mt-4 hidden">
                                <div class="flex items-center justify-between bg-green-100 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span id="analysisFileName" class="font-medium text-green-800"></span>
                                    </div>
                                    <button onclick="removeAnalysisFile()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Excel Data Preview -->
                            <div id="excelDataPreview" class="mt-4 hidden">
                                <h4 class="font-medium text-gray-800 mb-2">Anteprima Dati Estratti</h4>
                                <div class="bg-white p-4 rounded-lg border max-h-60 overflow-y-auto">
                                    <div id="excelPreviewContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurazione Output -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File da Generare</label>
                        <div class="grid md:grid-cols-3 gap-4">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateOffer" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Offerta Commerciale Word</span>
                                    <p class="text-xs text-gray-600 mt-1">Per Sales Manager VAR</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateSummary" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Sintesi Dati PDF</span>
                                    <p class="text-xs text-gray-600 mt-1">Executive summary progetto</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateCRM" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">File Excel CRM</span>
                                    <p class="text-xs text-gray-600 mt-1">Dati strutturati per caricamento CRM</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Parametri Personalizzazione -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-4">Personalizzazione Output</h4>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Note Commerciali</label>
                                <textarea id="commercialNotes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Note aggiuntive per l'offerta commerciale..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contatti Cliente</label>
                                <textarea id="clientContacts" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Referenti cliente, email, telefoni..."></textarea>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Scadenza Offerta</label>
                                <input type="date" id="offerExpiry" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Modalità Pagamento</label>
                                <select id="paymentTerms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Seleziona...</option>
                                    <option value="30gg">30 giorni fine mese</option>
                                    <option value="60gg">60 giorni fine mese</option>
                                    <option value="90gg">90 giorni fine mese</option>
                                    <option value="custom">Personalizzato</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Priorità Progetto</label>
                                <select id="projectPriority" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="standard">Standard</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Critica</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateFiles()" id="fileGenerateBtn" class="inline-flex items-center px-8 py-3 bg-green-600 text-white font-medium text-lg rounded-lg hover:bg-green-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Genera File
                        </button>
                    </div>
                </div>

                <!-- Generated Files Display -->
                <div id="generatedFiles" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">File Generati</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="downloadAllFiles()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Tutti i File
                            </button>
                            <button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Generazione
                            </button>
                        </div>
                    </div>
                    
                    <!-- Files List -->
                    <div id="filesList" class="grid md:grid-cols-3 gap-6">
                        <!-- Generated files will be displayed here -->
                    </div>
                    
                    <!-- File Contents Preview -->
                    <div id="filesPreview" class="space-y-6">
                        <!-- File previews will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento specializzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Alimentato dall'expertise di 51 anni, 823M€ fatturato, 3.850 persone, partnership certificate e soluzioni proprietarie
        </p>
    </div>

    <script>
        // API Configuration
        const API_KEY = "AIzaSyDjlVWJIzGCa5CnXbj_nQEj1aG2aHlLwnQ";
        
        // State management
        let analysisFile = null;
        let extractedData = {};
        let generatedFilesData = [];

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // File Generator Functions - UPDATED
        async function handleAnalysisUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.xlsx') && 
                !file.name.toLowerCase().endsWith('.xlsm') && 
                !file.name.toLowerCase().endsWith('.xls')) {
                alert('Seleziona solo file Excel (.xlsx, .xlsm o .xls)');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('Il file è troppo grande. Limite massimo: 10MB');
                return;
            }

            try {
                analysisFile = file;
                
                // Show file info
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
                
                // Process Excel file
                await processExcelFile(file);
                
            } catch (error) {
                console.error('Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        }

        async function processExcelFile(file) {
            try {
                const data = await readExcelFile(file);
                extractedData = extractKeyData(data);
                
                // Show preview
                displayExcelPreview(extractedData);
                
                // Enable generate button
                document.getElementById('fileGenerateBtn').disabled = false;
                
            } catch (error) {
                console.error('Errore nell\'elaborazione del file Excel:', error);
                alert('Errore nell\'elaborazione del file Excel: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        // Supporto per .xlsm (Excel con macro) e altri formati
                        const workbook = XLSX.read(data, { 
                            type: 'binary',
                            cellFormulas: false, // Ignora le formule per sicurezza
                            cellStyles: false,   // Non serve per l'estrazione dati
                            sheetStubs: true     // Include celle vuote
                        });
                        
                        const result = {};
                        workbook.SheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            // Converti in JSON con header numerico per maggiore flessibilità
                            result[sheetName] = XLSX.utils.sheet_to_json(sheet, { 
                                header: 1,
                                defval: '',  // Valore default per celle vuote
                                raw: false   // Converti tutto in stringhe per parsing uniforme
                            });
                        });
                        
                        resolve(result);
                    } catch (error) {
                        reject(new Error(`Errore nel parsing del file Excel: ${error.message}`));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Errore nella lettura del file'));
                };
                
                reader.readAsBinaryString(file);
            });
        }

        function extractKeyData(excelData) {
            const extracted = {
                cliente: '',
                progetto: '',
                totaleOfferta: 0,
                marginePercentuale: 0,
                margineEuro: 0,
                timeline: '',
                articoli: [],
                riepilogoPerTipo: {},
                riepilogoPerSezione: {},
                sheets: Object.keys(excelData),
                errori: [],
                debug: []
            };

            // DEBUG: Mostra tutti i fogli trovati
            extracted.debug.push(`Fogli trovati: ${Object.keys(excelData).join(', ')}`);

            // Cerca il foglio "Analisi Economica" - versione più flessibile
            let analisiSheet = null;
            let sheetName = '';
            
            // Prima prova con nomi esatti
            const possibiliNomi = [
                'Analisi Economica',
                'analisi economica',
                'ANALISI ECONOMICA',
                'Analisi economica',
                'AnalisiEconomica',
                'Analisi_Economica'
            ];

            for (let nome of possibiliNomi) {
                if (excelData[nome]) {
                    analisiSheet = excelData[nome];
                    sheetName = nome;
                    extracted.debug.push(`Trovato foglio con nome esatto: "${nome}"`);
                    break;
                }
            }

            // Se non trovato, cerca per contenuto parziale
            if (!analisiSheet) {
                Object.keys(excelData).forEach(name => {
                    const nameLower = name.toLowerCase().replace(/\s+/g, '').replace(/_/g, '');
                    if (nameLower.includes('analisi') || nameLower.includes('economic')) {
                        analisiSheet = excelData[name];
                        sheetName = name;
                        extracted.debug.push(`Trovato foglio per contenuto: "${name}"`);
                    }
                });
            }

            // Se ancora non trovato, usa il primo foglio disponibile
            if (!analisiSheet && Object.keys(excelData).length > 0) {
                const primoFoglio = Object.keys(excelData)[0];
                analisiSheet = excelData[primoFoglio];
                sheetName = primoFoglio;
                extracted.debug.push(`Usando primo foglio disponibile: "${primoFoglio}"`);
                extracted.errori.push(`Foglio "Analisi Economica" non trovato. Usando "${primoFoglio}"`);
            }

            if (!analisiSheet) {
                extracted.errori.push('Nessun foglio trovato nel file Excel');
                return extracted;
            }

            // DEBUG: Mostra info sul foglio selezionato
            extracted.debug.push(`Foglio selezionato: "${sheetName}" con ${analisiSheet.length} righe`);
            
            // DEBUG: Mostra TUTTE le righe dalla 3 in poi (anche quelle apparentemente vuote)
            extracted.debug.push(`=== ANALISI COMPLETA FOGLIO (dalla riga 3) ===`);
            extracted.debug.push(`Foglio "${sheetName}" ha ${analisiSheet.length} righe totali`);
            
            let righeAnalizzate = 0;
            let righeConDescrizione = 0;
            
            // Scorri TUTTE le righe dalla 3 in poi
            for (let i = 2; i < analisiSheet.length; i++) { // Riga 3 = indice 2
                const row = analisiSheet[i];
                righeAnalizzate++;
                
                // Mostra SEMPRE la riga nel debug, anche se vuota
                if (!row || row.length === 0) {
                    extracted.debug.push(`Riga ${i + 1}: RIGA COMPLETAMENTE VUOTA`);
                    continue;
                }
                
                // Mostra tutte le colonne A-V
                const rigaCompleta = row.slice(0, 22).map((cell, idx) => {
                    const lettera = String.fromCharCode(65 + idx);
                    return `${lettera}:${cell || 'vuoto'}`;
                }).join(' | ');
                extracted.debug.push(`Riga ${i + 1}: ${rigaCompleta}`);
                
                // Controlla se ha un valore nella colonna J (Costo Unitario)
                const costoUnitario = row[9]; // Colonna J
                const descrizione = row[6]; // Colonna G
                
                if (costoUnitario && costoUnitario !== '' && costoUnitario !== 0) {
                    righeConDescrizione++;
                    const quantita = row[7] || '0';
                    const venditaUnitario = row[16] || '0';
                    const venditaTotale = row[17] || '0';
                    const colonnaU = row[20] || 'vuoto';
                    
                    extracted.debug.push(`   → CON COSTO (J): €${costoUnitario} | Descr:"${descrizione}" | Qty:${quantita} | Vendita Tot:€${venditaTotale} | U:${colonnaU}`);
                }
                
                extracted.debug.push(`---`);
            }
            
            extracted.debug.push(`=== RIEPILOGO SCANSIONE ===`);
            extracted.debug.push(`Righe analizzate dalla 3 in poi: ${righeAnalizzate}`);
            extracted.debug.push(`Righe con Costo Unitario (J) trovate: ${righeConDescrizione}`);

            // Definizione colonne (indici da 0)
            const colonne = {
                sezione: 0,           // A - Sezione Descrizione Attività
                areaInteresse: 1,     // B - Area di Interesse
                sottocategoria: 2,    // C - Sottocategoria
                tipoArticolo: 3,      // D - Tipo Articolo
                produttore: 4,        // E - Produttore - Vendor
                codiceArticolo: 5,    // F - Codice Articolo Produttore
                descrizioneArticolo: 6, // G - Descrizione Articolo
                quantita: 7,          // H - Q.tà
                listinoUnitario: 8,   // I - Listino Unitario
                costoUnitario: 9,     // J - Costo Unitario
                scontoBase: 10,       // K - Sconto Base (%)
                scontoAgg1: 11,       // L - Sconto Aggiuntivo 1 (%)
                scontoAgg2: 12,       // M - Sconto Aggiuntivo 2 (%)
                costoUnitarioFinale: 13, // N - Costo Unitario
                costoTotale: 14,      // O - Costo Totale
                margine: 15,          // P - Margine
                venditaUnitario: 16,  // Q - Vendita Unitario
                venditaTotale: 17,    // R - Vendita Totale
                markup: 18,           // S - MarkUp
                colonnaT: 19,         // T - Colonna T
                colonnaU: 20,         // U - Colonna U
                colonnaV: 21          // V - Colonna V
            };

            // Leggi TUTTE le righe dalla riga 3 che hanno un valore nella colonna J (Costo Unitario)
            for (let i = 2; i < analisiSheet.length; i++) {
                const row = analisiSheet[i];
                
                // Salta solo righe completamente vuote
                if (!row || row.length === 0) continue;
                
                // CRITERIO PRINCIPALE: deve avere un valore nella colonna J (Costo Unitario)
                const costoUnitario = row[colonne.costoUnitario];
                if (!costoUnitario || costoUnitario === '' || (typeof costoUnitario === 'number' && costoUnitario === 0)) {
                    continue;
                }
                
                // Prendi anche la descrizione per completezza
                const descrizione = row[colonne.descrizioneArticolo] || `Riga ${i + 1}`;
                
                // Estrai TUTTO - senza filtri per totali o subtotali
                const quantita = parseFloat(row[colonne.quantita]) || 0;
                
                const articolo = {
                    riga: i + 1, // Numero riga Excel (base 1)
                    sezione: row[colonne.sezione] || '',
                    areaInteresse: row[colonne.areaInteresse] || '',
                    sottocategoria: row[colonne.sottocategoria] || '',
                    tipoArticolo: row[colonne.tipoArticolo] || '',
                    produttore: row[colonne.produttore] || '',
                    codiceArticolo: row[colonne.codiceArticolo] || '',
                    descrizioneArticolo: descrizione.toString().trim(),
                    quantita: quantita,
                    listinoUnitario: parseFloat(row[colonne.listinoUnitario]) || 0,
                    costoUnitario: parseFloat(costoUnitario) || 0,
                    scontoBase: parseFloat(row[colonne.scontoBase]) || 0,
                    scontoAgg1: parseFloat(row[colonne.scontoAgg1]) || 0,
                    scontoAgg2: parseFloat(row[colonne.scontoAgg2]) || 0,
                    costoUnitarioFinale: parseFloat(row[colonne.costoUnitarioFinale]) || 0,
                    costoTotale: parseFloat(row[colonne.costoTotale]) || 0,
                    margine: parseFloat(row[colonne.margine]) || 0,
                    venditaUnitario: parseFloat(row[colonne.venditaUnitario]) || 0,
                    venditaTotale: parseFloat(row[colonne.venditaTotale]) || 0,
                    markup: parseFloat(row[colonne.markup]) || 0,
                    colonnaT: parseFloat(row[colonne.colonnaT]) || 0, // Tratta T come numero per prezzo unitario
                    colonnaU: parseFloat(row[colonne.colonnaU]) || 0, // Tratta U come numero per prezzo totale
                    colonnaV: row[colonne.colonnaV] || ''
                };

                extracted.articoli.push(articolo);
            }

            // Calcola TUTTI i totali e riepiloghi dettagliati - FIX CALCOLI
            let totaleQuantita = 0;
            let totaleListino = 0;
            let totaleCosti = 0;
            let totaleVendita = 0;
            let totaleColonnaU = 0;
            let totaleMargine = 0;

            extracted.articoli.forEach(art => {
                totaleQuantita += art.quantita || 0;
                totaleListino += art.listinoUnitario || 0;
                totaleCosti += art.costoUnitario || 0;
                totaleVendita += art.venditaTotale || 0;
                totaleColonnaU += art.colonnaU || 0;
                totaleMargine += art.margine || 0;
            });

            // Assegna i totali corretti
            extracted.totaleQuantita = totaleQuantita;
            extracted.totaleColonnaI = totaleListino;
            extracted.totaleColonnaJ = totaleCosti;
            extracted.totaleColonnaR = totaleVendita;
            extracted.totaleColonnaU = totaleColonnaU;
            extracted.margineEuro = totaleMargine;
            extracted.totaleOfferta = totaleVendita;
            extracted.marginePercentuale = totaleVendita > 0 ? (totaleMargine / totaleVendita * 100) : 0;
            extracted.totaleCostoTotale = extracted.articoli.reduce((sum, art) => sum + (art.costoTotale || 0), 0);

            // Riepilogo per tipo articolo
            extracted.articoli.forEach(art => {
                const tipo = art.tipoArticolo || 'Non Specificato';
                if (!extracted.riepilogoPerTipo[tipo]) {
                    extracted.riepilogoPerTipo[tipo] = {
                        quantita: 0,
                        costoTotale: 0,
                        venditaTotale: 0,
                        margine: 0,
                        articoli: 0
                    };
                }
                extracted.riepilogoPerTipo[tipo].quantita += art.quantita;
                extracted.riepilogoPerTipo[tipo].costoTotale += art.costoTotale;
                extracted.riepilogoPerTipo[tipo].venditaTotale += art.venditaTotale;
                extracted.riepilogoPerTipo[tipo].margine += art.margine;
                extracted.riepilogoPerTipo[tipo].articoli += 1;
            });

            // Riepilogo per sezione
            extracted.articoli.forEach(art => {
                const sezione = art.sezione || 'Non Specificato';
                if (!extracted.riepilogoPerSezione[sezione]) {
                    extracted.riepilogoPerSezione[sezione] = {
                        quantita: 0,
                        costoTotale: 0,
                        venditaTotale: 0,
                        margine: 0,
                        articoli: 0
                    };
                }
                extracted.riepilogoPerSezione[sezione].quantita += art.quantita;
                extracted.riepilogoPerSezione[sezione].costoTotale += art.costoTotale;
                extracted.riepilogoPerSezione[sezione].venditaTotale += art.venditaTotale;
                extracted.riepilogoPerSezione[sezione].margine += art.margine;
                extracted.riepilogoPerSezione[sezione].articoli += 1;
            });

            return extracted;
        }

        function displayExcelPreview(data) {
            const previewContainer = document.getElementById('excelPreviewContent');
            
            let html = '<div class="space-y-3">';
            
            // DEBUG INFO - mostra sempre per capire cosa succede
            if (data.debug && data.debug.length > 0) {
                html += `<div class="bg-yellow-50 p-3 rounded border border-yellow-200">`;
                html += `<strong class="text-yellow-800">Debug Info:</strong><br>`;
                data.debug.forEach(debug => {
                    html += `• ${debug}<br>`;
                });
                html += `</div>`;
            }
            
            // Errori eventuali
            if (data.errori.length > 0) {
                html += `<div class="bg-red-50 p-3 rounded border border-red-200">`;
                html += `<strong class="text-red-800">Errori/Avvisi:</strong><br>`;
                data.errori.forEach(errore => {
                    html += `• ${errore}<br>`;
                });
                html += `</div>`;
            }
            
            // Dati principali estratti con TUTTI i riepiloghi
            html += `<div class="bg-blue-50 p-3 rounded border">`;
            html += `<strong>Analisi Economica DSA - Riepiloghi Totali:</strong><br>`;
            html += `Articoli con Costo (J): <strong>${data.articoli.length}</strong><br>`;
            html += `Totale Quantità: <strong>${data.totaleQuantita.toLocaleString('it-IT')}</strong><br>`;
            html += `Totale Listino (I): <strong>€${data.totaleColonnaI.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>`;
            html += `Totale Costi (J): <strong>€${data.totaleColonnaJ.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>`;
            html += `Totale Vendita (R): <strong>€${data.totaleColonnaR.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>`;
            html += `Totale Colonna U: <strong>${data.totaleColonnaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>`;
            html += `Margine Totale: <strong>€${data.margineEuro.toLocaleString('it-IT', {minimumFractionDigits: 2})} (${data.marginePercentuale.toFixed(2)}%)</strong><br>`;
            html += `Fogli nel File: ${data.sheets.join(', ')}`;
            html += `</div>`;
            
            // Se non ci sono articoli, mostra un messaggio più dettagliato
            if (data.articoli.length === 0) {
                html += `<div class="bg-orange-50 p-3 rounded border border-orange-200">`;
                html += `<strong class="text-orange-800">Nessun articolo estratto</strong><br>`;
                html += `Possibili cause:<br>`;
                html += `• Il foglio non contiene dati dalle riga 3 in poi<br>`;
                html += `• Le colonne non corrispondono alla struttura attesa<br>`;
                html += `• I dati sono in un formato diverso<br><br>`;
                html += `<strong>Verifica che:</strong><br>`;
                html += `• La colonna G contenga le descrizioni degli articoli<br>`;
                html += `• La colonna H contenga le quantità (numeri > 0)<br>`;
                html += `• I dati inizino dalla riga 3`;
                html += `</div>`;
            }
            
            // Riepilogo per tipo articolo
            if (Object.keys(data.riepilogoPerTipo).length > 0) {
                html += `<div class="bg-green-50 p-3 rounded border">`;
                html += `<strong>Riepilogo per Tipo Articolo:</strong><br>`;
                Object.entries(data.riepilogoPerTipo).forEach(([tipo, totali]) => {
                    html += `• <strong>${tipo}</strong>: ${totali.articoli} articoli, €${totali.venditaTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}<br>`;
                });
                html += `</div>`;
            }
            
            // Riepilogo per sezione
            if (Object.keys(data.riepilogoPerSezione).length > 0) {
                html += `<div class="bg-purple-50 p-3 rounded border">`;
                html += `<strong>Riepilogo per Sezione:</strong><br>`;
                Object.entries(data.riepilogoPerSezione).slice(0, 5).forEach(([sezione, totali]) => {
                    html += `• <strong>${sezione}</strong>: ${totali.articoli} articoli, €${totali.venditaTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}<br>`;
                });
                if (Object.keys(data.riepilogoPerSezione).length > 5) {
                    html += `... e altre ${Object.keys(data.riepilogoPerSezione).length - 5} sezioni<br>`;
                }
                html += `</div>`;
            }
            
            // Esempio articoli
            if (data.articoli.length > 0) {
                html += `<div class="bg-green-50 p-3 rounded border">`;
                html += `<strong>Primi Articoli Estratti:</strong><br>`;
                data.articoli.slice(0, 3).forEach(art => {
                    html += `• <strong>${art.descrizioneArticolo}</strong><br>`;
                    html += `&nbsp;&nbsp;Qty: ${art.quantita}, Prezzo: €${art.venditaUnitario.toLocaleString('it-IT', {minimumFractionDigits: 2})}, Totale: €${art.venditaTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}<br>`;
                    html += `&nbsp;&nbsp;Tipo: ${art.tipoArticolo}, Produttore: ${art.produttore}<br><br>`;
                });
                if (data.articoli.length > 3) {
                    html += `... e altri ${data.articoli.length - 3} articoli`;
                }
                html += `</div>`;
            }
            
            html += '</div>';
            
            previewContainer.innerHTML = html;
            document.getElementById('excelDataPreview').classList.remove('hidden');
        }

        function removeAnalysisFile() {
            analysisFile = null;
            extractedData = {};
            document.getElementById('uploadedAnalysisFile').classList.add('hidden');
            document.getElementById('excelDataPreview').classList.add('hidden');
            document.getElementById('analysisUpload').value = '';
            document.getElementById('fileGenerateBtn').disabled = true;
        }

        async function generateFiles() {
            // Validation
            const clientName = document.getElementById('fileGenClientName').value.trim();
            if (!clientName || !analysisFile) {
                alert('Compila il nome cliente e carica il file di analisi economica');
                return;
            }

            const generateOffer = document.getElementById('generateOffer').checked;
            const generateSummary = document.getElementById('generateSummary').checked;
            const generateCRM = document.getElementById('generateCRM').checked;

            if (!generateOffer && !generateSummary && !generateCRM) {
                alert('Seleziona almeno un tipo di file da generare');
                return;
            }

            // Show loading
            const btn = document.getElementById('fileGenerateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `
                <svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generazione in corso...
            `;
            btn.disabled = true;

            try {
                const projectData = {
                    cliente: clientName,
                    projectCode: document.getElementById('projectCode').value,
                    salesManager: document.getElementById('salesManager').value,
                    commercialNotes: document.getElementById('commercialNotes').value,
                    clientContacts: document.getElementById('clientContacts').value,
                    offerExpiry: document.getElementById('offerExpiry').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    projectPriority: document.getElementById('projectPriority').value,
                    extractedData: extractedData
                };

                generatedFilesData = [];

                if (generateOffer) {
                    const offerContent = await generateCommercialOffer(projectData);
                    generatedFilesData.push({
                        type: 'offer',
                        name: `Offerta_Commerciale_${clientName.replace(/\s+/g, '_')}.docx`,
                        content: offerContent,
                        icon: 'document',
                        color: 'blue'
                    });
                }

                if (generateSummary) {
                    const summaryContent = await generateExecutiveSummary(projectData);
                    generatedFilesData.push({
                        type: 'summary',
                        name: `Sintesi_Progetto_${clientName.replace(/\s+/g, '_')}.pdf`,
                        content: summaryContent,
                        icon: 'document-text',
                        color: 'purple'
                    });
                }

                if (generateCRM) {
                    const crmContent = await generateCRMFile(projectData);
                    generatedFilesData.push({
                        type: 'crm',
                        name: `CRM_Data_${clientName.replace(/\s+/g, '_')}.xlsx`,
                        content: crmContent,
                        icon: 'table',
                        color: 'green'
                    });
                }

                displayGeneratedFiles();
                
                document.getElementById('fileGeneratorForm').classList.add('hidden');
                document.getElementById('generatedFiles').classList.remove('hidden');
                document.getElementById('generatedFiles').classList.add('fade-in');

            } catch (error) {
                alert('Errore nella generazione dei file: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateCommercialOffer(projectData) {
            const data = projectData.extractedData;
            
            // Genera contenuto direttamente senza API
            const dataOdierna = new Date().toLocaleDateString('it-IT');
            
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.4; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #1e40af; }
        .date-location { text-align: left; margin: 20px 0; }
        .recipient { margin: 20px 0; }
        .object { font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .total-row { font-weight: bold; font-size: 16px; }
        .conditions-table { margin: 30px 0; }
        .conditions-table td { border: 1px solid #333; padding: 10px; }
        .signature { margin-top: 50px; }
        .amount { text-align: right; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">VAR GROUP S.P.A.</div>
        <div>Via della Liberazione, 15 - 20098 San Giuliano Milanese (MI)</div>
        <div>Tel. +39 02 2760141 - Fax +39 02 27604206</div>
    </div>

    <div class="date-location">
        Cormano (MI), ${dataOdierna}
    </div>

    <div class="recipient">
        <strong>Spett.le</strong><br>
        <strong>${projectData.cliente.toUpperCase()}</strong><br>
        [Indirizzo Cliente]<br>
        [CAP, Città]
    </div>

    <div class="object">
        <strong>Oggetto: ${projectData.projectCode || 'Refresh tecnologico'}</strong>
    </div>

    <p>Con riferimento ai colloqui intercorsi vi sottoponiamo la presente proposta relativa al progetto in oggetto.</p>

    <h3>SOLUZIONE PROPOSTA</h3>

    <table>
        <thead>
            <tr>
                <th>Q.tà</th>
                <th>Descrizione</th>
                <th>Prezzo unitario</th>
                <th>Prezzo totale</th>
            </tr>
        </thead>
        <tbody>
            ${data.articoli.map(art => `
            <tr>
                <td>${art.scontoBase}</td>
                <td>${art.listinoUnitario.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td class="amount">€ ${art.colonnaT.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td class="amount">€ ${art.colonnaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
            </tr>
            `).join('')}
            <tr class="total-row">
                <td colspan="3" style="text-align: right;"><strong>TOTALE COMPLESSIVO:</strong></td>
                <td class="amount"><strong>€ ${data.totaleColonnaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
            </tr>
        </tbody>
    </table>

    <h3>CONDIZIONI DI FORNITURA</h3>
    <table class="conditions-table">
        <tr>
            <td><strong>Consegna</strong></td>
            <td>Da concordare</td>
        </tr>
        <tr>
            <td><strong>Iva</strong></td>
            <td>Esclusa</td>
        </tr>
        <tr>
            <td><strong>Validità Offerta</strong></td>
            <td>${projectData.offerExpiry || '30 giorni dalla data della presente offerta'}</td>
        </tr>
        <tr>
            <td><strong>Spese di trasporto</strong></td>
            <td>Incluse</td>
        </tr>
        <tr>
            <td><strong>Modalità e Termini di Pagamento</strong></td>
            <td>${projectData.paymentTerms || 'Da concordare'}</td>
        </tr>
    </table>

    <div class="signature">
        <p>Siamo a Vostra disposizione per qualsiasi chiarimento tecnico o commerciale e cogliamo l'occasione per porgervi i nostri migliori saluti.</p>
        
        <p><strong>Var Group S.p.A.</strong></p>
        <p><em>${projectData.salesManager || 'Sales Manager'}</em></p>
        
        <br><br>
        <p><strong>PER ACCETTAZIONE OFFERTA PROT. _______________________</strong></p>
    </div>
</body>
</html>`;

            return htmlContent;
        }

        async function generateExecutiveSummary(projectData) {
            const data = projectData.extractedData;
            
            // Genera sintesi economica con solo colonne I, J, R, U
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.4; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #333; padding: 8px; text-align: center; }
        th { background-color: #1e40af; color: white; font-weight: bold; }
        .amount { text-align: right; }
        .total-row { font-weight: bold; background-color: #f0f8ff; }
        .summary { background-color: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>SINTESI ECONOMICA</h1>
        <h2>${projectData.cliente}</h2>
        <p>Data: ${new Date().toLocaleDateString('it-IT')} | Progetto: ${projectData.projectCode || 'N/A'}</p>
    </div>

    <div class="summary">
        <h3>Riepilogo Progetto</h3>
        <p><strong>Totale Offerta:</strong> € ${data.totaleOfferta.toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
        <p><strong>Margine:</strong> € ${data.margineEuro.toLocaleString('it-IT', {minimumFractionDigits: 2})} (${data.marginePercentuale.toFixed(2)}%)</p>
        <p><strong>Articoli:</strong> ${data.articoli.length}</p>
    </div>

    <h3>Dettaglio Economico (Colonne I, J, R, U)</h3>
    <table>
        <thead>
            <tr>
                <th>Articolo</th>
                <th>Listino Unitario (I)</th>
                <th>Costo Unitario (J)</th>
                <th>Vendita Totale (R)</th>
                <th>Colonna U</th>
            </tr>
        </thead>
        <tbody>
            ${data.articoli.map((art, index) => `
            <tr>
                <td>${art.listinoUnitario.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td class="amount">€ ${art.listinoUnitario.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td class="amount">€ ${art.costoUnitario.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td class="amount">€ ${art.venditaTotale.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                <td>${art.colonnaU || '-'}</td>
            </tr>
            `).join('')}
            <tr class="total-row">
                <td><strong>TOTALI</strong></td>
                <td class="amount"><strong>€ ${data.totaleColonnaI.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                <td class="amount"><strong>€ ${data.totaleColonnaJ.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                <td class="amount"><strong>€ ${data.totaleColonnaR.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
                <td class="amount"><strong>${data.totaleColonnaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td>
            </tr>
        </tbody>
    </table>

    <div class="summary">
        <h3>Note</h3>
        <p>Sintesi economica estratta automaticamente dall'Analisi Economica DSA.</p>
        <p>Documento generato il: ${new Date().toLocaleString('it-IT')}</p>
        ${projectData.commercialNotes ? `<p><strong>Note commerciali:</strong> ${projectData.commercialNotes}</p>` : ''}
    </div>
</body>
</html>`;

            return htmlContent;
        }

        async function generateCRMFile(projectData) {
            const data = projectData.extractedData;
            
            // Genera contenuto CSV/testo per CRM
            const crmData = {
                cliente: projectData.cliente,
                opportunita: `MW_${projectData.projectCode}_${new Date().getFullYear()}`,
                dataCreazione: new Date().toISOString().split('T')[0],
                salesManager: projectData.salesManager,
                valoreOfferta: data.totaleOfferta,
                margineEuro: data.margineEuro,
                marginePercentuale: data.marginePercentuale.toFixed(2),
                scadenzaOfferta: projectData.offerExpiry,
                modalitaPagamento: projectData.paymentTerms,
                priorita: projectData.projectPriority,
                stato: 'Proposta Inviata',
                articoliTotali: data.articoli.length,
                sezioniCoperte: Object.keys(data.riepilogoPerSezione).length,
                noteCommerciali: projectData.commercialNotes,
                contattiCliente: projectData.clientContacts,
                // Breakdown per tipo
                tecnologia: data.riepilogoPerTipo['Tecnologia']?.venditaTotale || 0,
                servizio: data.riepilogoPerTipo['Servizio']?.venditaTotale || 0,
                manutenzione: data.riepilogoPerTipo['Manutenzione']?.venditaTotale || 0,
                licenze: data.riepilogoPerTipo['Sottoscrizione Licenza']?.venditaTotale || 0,
                altro: data.riepilogoPerTipo['Altro']?.venditaTotale || 0
            };

            return JSON.stringify(crmData, null, 2);
        }

        async function generateCRMFile(projectData) {
            const data = projectData.extractedData;
            
            // Generate structured data for CRM with detailed breakdown
            const crmData = {
                // Dati base opportunità
                cliente: projectData.cliente,
                opportunita: `MW_${projectData.projectCode}_${new Date().getFullYear()}`,
                dataCreazione: new Date().toISOString().split('T')[0],
                salesManager: projectData.salesManager,
                
                // Dati economici
                valoreOfferta: data.totaleOfferta,
                margineEuro: data.margineEuro,
                marginePercentuale: data.marginePercentuale.toFixed(2),
                
                // Configurazione offerta  
                scadenzaOfferta: projectData.offerExpiry,
                modalitaPagamento: projectData.paymentTerms,
                priorita: projectData.projectPriority,
                stato: 'Proposta Inviata',
                
                // Breakdown per tipo
                tecnologia: data.riepilogoPerTipo['Tecnologia']?.venditaTotale || 0,
                servizio: data.riepilogoPerTipo['Servizio']?.venditaTotale || 0,
                manutenzione: data.riepilogoPerTipo['Manutenzione']?.venditaTotale || 0,
                licenze: data.riepilogoPerTipo['Sottoscrizione Licenza']?.venditaTotale || 0,
                altro: data.riepilogoPerTipo['Altro']?.venditaTotale || 0,
                
                // Statistiche
                articoliTotali: data.articoli.length,
                sezioniCoperte: Object.keys(data.riepilogoPerSezione).length,
                
                // Note e contatti
                noteCommerciali: projectData.commercialNotes,
                contattiCliente: projectData.clientContacts,
                
                // Dettaglio sezioni principali (top 5)
                sezioniPrincipali: Object.entries(data.riepilogoPerSezione)
                    .sort((a, b) => b[1].venditaTotale - a[1].venditaTotale)
                    .slice(0, 5)
                    .map(([nome, totali]) => ({
                        nome: nome,
                        valore: totali.venditaTotale,
                        articoli: totali.articoli
                    }))
            };

            return JSON.stringify(crmData, null, 2);
        }

        function displayGeneratedFiles() {
            const filesList = document.getElementById('filesList');
            const filesPreview = document.getElementById('filesPreview');
            
            // Files list
            let filesHTML = '';
            generatedFilesData.forEach((file, index) => {
                const iconPath = getIconPath(file.icon);
                filesHTML += `
                    <div class="border border-${file.color}-200 rounded-lg p-4 bg-${file.color}-50">
                        <div class="flex items-center mb-3">
                            ${iconPath}
                            <span class="font-medium text-${file.color}-800 ml-2">${getFileTypeLabel(file.type)}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">${file.name}</p>
                        <div class="flex gap-2">
                            <button onclick="downloadFile(${index})" class="flex-1 px-3 py-2 bg-${file.color}-600 text-white text-xs rounded hover:bg-${file.color}-700">
                                Download
                            </button>
                            <button onclick="previewFile(${index})" class="flex-1 px-3 py-2 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300">
                                Anteprima
                            </button>
                        </div>
                    </div>
                `;
            });
            
            filesList.innerHTML = filesHTML;
            
            // Auto-show preview of first file to verify it's working
            if (generatedFilesData.length > 0) {
                setTimeout(() => previewFile(0), 500);
            }
        }

        function getIconPath(iconType) {
            const icons = {
                'document': `<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'document-text': `<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'table': `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h12a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1z"></path></svg>`
            };
            return icons[iconType] || icons['document'];
        }

        function getFileTypeLabel(type) {
            const labels = {
                'offer': 'Offerta Commerciale',
                'summary': 'Sintesi Progetto', 
                'crm': 'Dati CRM'
            };
            return labels[type] || type;
        }

        function downloadFile(index) {
            const file = generatedFilesData[index];
            
            let mimeType, dataUrl;
            
            if (file.type === 'crm') {
                // JSON to Excel conversion
                const ws = XLSX.utils.json_to_sheet([JSON.parse(file.content)]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "CRM_Data");
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                dataUrl = URL.createObjectURL(blob);
            } else {
                // HTML content
                const blob = new Blob([file.content], { type: 'text/html' });
                dataUrl = URL.createObjectURL(blob);
            }
            
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(dataUrl);
        }

        function previewFile(index) {
            const file = generatedFilesData[index];
            const previewContainer = document.getElementById('filesPreview');
            
            let previewHTML = `
                <div class="bg-white border rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-medium text-gray-800">Anteprima: ${file.name}</h4>
                        <button onclick="downloadFile(${index})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 mr-2">
                            Scarica File
                        </button>
                        <button onclick="copyFileContent(${index})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            Copia Contenuto
                        </button>
                    </div>
                    <div class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto border">
            `;
            
            if (file.type === 'crm') {
                try {
                    const data = JSON.parse(file.content);
                    previewHTML += '<pre class="text-sm font-mono">' + JSON.stringify(data, null, 2) + '</pre>';
                } catch (e) {
                    previewHTML += '<p class="text-red-600">Errore nel parsing JSON del file CRM</p>';
                }
            } else {
                // Show HTML content with proper formatting
                const cleanContent = file.content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                previewHTML += `<div class="prose max-w-none">${cleanContent.substring(0, 3000)}${file.content.length > 3000 ? '<p><em>... contenuto troncato per anteprima ...</em></p>' : ''}</div>`;
            }
            
            previewHTML += `
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = previewHTML;
        }

        function copyFileContent(index) {
            const file = generatedFilesData[index];
            
            let contentToCopy;
            if (file.type === 'crm') {
                contentToCopy = file.content; // JSON già formattato
            } else {
                // Rimuovi script e tag HTML per ottenere contenuto pulito per copia
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = file.content;
                
                // Rimuovi script tags
                const scripts = tempDiv.querySelectorAll('script');
                scripts.forEach(script => script.remove());
                
                contentToCopy = tempDiv.innerHTML;
            }
            
            // Copia negli appunti
            navigator.clipboard.writeText(contentToCopy).then(() => {
                // Mostra feedback visivo
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copiato!';
                button.classList.add('bg-green-800');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('bg-green-800');
                }, 2000);
            }).catch(err => {
                alert('Errore nella copia: ' + err.message);
            });
        }

        function resetFileGenerator() {
            // Reset all form fields
            document.getElementById('fileGenClientName').value = '';
            document.getElementById('projectCode').value = '';
            document.getElementById('salesManager').value = '';
            document.getElementById('commercialNotes').value = '';
            document.getElementById('clientContacts').value = '';
            document.getElementById('offerExpiry').value = '';
            document.getElementById('paymentTerms').value = '';
            document.getElementById('projectPriority').value = 'standard';
            
            // Reset checkboxes
            document.getElementById('generateOffer').checked = true;
            document.getElementById('generateSummary').checked = true;
            document.getElementById('generateCRM').checked = true;
            
            // Reset file state
            removeAnalysisFile();
            generatedFilesData = [];
            
            // Show form, hide results
            document.getElementById('fileGeneratorForm').classList.remove('hidden');
            document.getElementById('generatedFiles').classList.add('hidden');
        }

        // Call Gemini API
        async function callGeminiAPI(prompt) {
            const modelName = "gemini-2.5-pro";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

            const requestBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });
            
            if (!response.ok) {
                throw new Error(`API Error (${response.status}): ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                let rawText = result.candidates[0].content.parts[0].text;
                return rawText.replace(/^\s*```(html)?\n?/, '').replace(/\n?```\s*$/, '');
            } else {
                throw new Error("Risposta AI non nel formato atteso.");
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default view
            showIntro();
            
            // Add click handler for home button
            document.getElementById('homeBtn').addEventListener('click', showIntro);
            
            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('offerExpiry').value = tomorrow.toISOString().split('T')[0];
            
            // Disable generate button initially
            document.getElementById('fileGenerateBtn').disabled = true;
        });
    </script>
</body>
</html>
