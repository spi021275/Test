<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA sfruttando l'expertise di 51 anni, partnership certificate e soluzioni proprietarie.</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 3 - NEW -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generazione File</h3>
                            <p class="text-gray-600 mb-4">Trasforma l'Analisi Economica DSA in offerta commerciale, sintesi dati e file CRM pronti all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module (EXISTING) -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Trasforma i tuoi appunti del meeting in un brief tecnico strutturato per il team DSA utilizzando l'expertise completa della BU (51 anni esperienza, 823M‚Ç¨ fatturato, 3.850 persone)</p>
                
                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 1 - Funzionalit√† esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- Space Wizard Module (EXISTING) -->
        <div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Wizard Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Configura la soluzione tecnologica ottimale per il tuo spazio con analisi AI automatica da foto/planimetrie o inserimento manuale</p>
                
                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 2 - Funzionalit√† esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- File Generator Module - NEW -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>
                
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione File da Analisi Economica DSA</h2>
                <p class="text-gray-600 mb-8">Carica il file Excel "Analisi Economica" dal DSA e genera automaticamente offerta commerciale, sintesi dati e file CRM</p>
                
                <div id="fileGeneratorForm" class="space-y-8">
                    
                    <!-- Dati Base Progetto -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto</label>
                            <input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. PRJ-2024-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sales Manager VAR</label>
                            <input type="text" id="salesManager" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. Mario Rossi">
                        </div>
                    </div>

                    <!-- Upload Analisi Economica -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-green-300 border-dashed rounded-lg bg-green-50 hover:bg-green-100 cursor-pointer transition-colors">
                                <svg class="w-10 h-10 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span class="text-sm text-green-700 font-medium">Carica Analisi Economica DSA</span>
                                <span class="text-xs text-green-600 mt-1">.xlsx, .xlsm, .xls (max 10MB)</span>
                            </div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls" onchange="handleAnalysisUpload(event)">
                            
                            <!-- Uploaded File Display -->
                            <div id="uploadedAnalysisFile" class="mt-4 hidden">
                                <div class="flex items-center justify-between bg-green-100 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span id="analysisFileName" class="font-medium text-green-800"></span>
                                    </div>
                                    <button onclick="removeAnalysisFile()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Excel Data Preview -->
                            <div id="excelDataPreview" class="mt-4 hidden">
                                <h4 class="font-medium text-gray-800 mb-2">Anteprima Dati Estratti</h4>
                                <div class="bg-white p-4 rounded-lg border max-h-60 overflow-y-auto">
                                    <div id="excelPreviewContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurazione Output -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File da Generare</label>
                        <div class="grid md:grid-cols-3 gap-4">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateOffer" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Offerta Commerciale Word</span>
                                    <p class="text-xs text-gray-600 mt-1">Per Sales Manager VAR</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateSummary" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Sintesi Dati PDF</span>
                                    <p class="text-xs text-gray-600 mt-1">Executive summary progetto</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateCRM" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">File Excel CRM</span>
                                    <p class="text-xs text-gray-600 mt-1">Dati strutturati per caricamento CRM</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Parametri Personalizzazione -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-4">Personalizzazione Output</h4>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Note Commerciali</label>
                                <textarea id="commercialNotes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Note aggiuntive per l'offerta commerciale..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contatti Cliente</label>
                                <textarea id="clientContacts" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Referenti cliente, email, telefoni..."></textarea>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Scadenza Offerta</label>
                                <input type="date" id="offerExpiry" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Modalit√† Pagamento</label>
                                <select id="paymentTerms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Seleziona...</option>
                                    <option value="30gg">30 giorni fine mese</option>
                                    <option value="60gg">60 giorni fine mese</option>
                                    <option value="90gg">90 giorni fine mese</option>
                                    <option value="custom">Personalizzato</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Priorit√† Progetto</label>
                                <select id="projectPriority" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="standard">Standard</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Critica</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button onclick="generateFiles()" id="fileGenerateBtn" class="inline-flex items-center px-8 py-3 bg-green-600 text-white font-medium text-lg rounded-lg hover:bg-green-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Genera File
                        </button>
                    </div>
                </div>

                <!-- Generated Files Display -->
                <div id="generatedFiles" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">File Generati</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="downloadAllFiles()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Tutti i File
                            </button>
                            <button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Generazione
                            </button>
                        </div>
                    </div>
                    
                    <!-- Files List -->
                    <div id="filesList" class="grid md:grid-cols-3 gap-6">
                        <!-- Generated files will be displayed here -->
                    </div>
                    
                    <!-- File Contents Preview -->
                    <div id="filesPreview" class="space-y-6">
                        <!-- File previews will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento specializzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Alimentato dall'expertise di 51 anni, 823M‚Ç¨ fatturato, 3.850 persone, partnership certificate e soluzioni proprietarie
        </p>
    </div>

    <script>
        // API Configuration
        const API_KEY = "AIzaSyDjlVWJIzGCa5CnXbj_nQEj1aG2aHlLwnQ";
        
        // State management
        let analysisFile = null;
        let extractedData = {};
        let generatedFilesData = [];

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // File Generator Functions
        async function handleAnalysisUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.xlsx') && 
                !file.name.toLowerCase().endsWith('.xlsm') && 
                !file.name.toLowerCase().endsWith('.xls')) {
                alert('Seleziona solo file Excel (.xlsx, .xlsm o .xls)');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('Il file √® troppo grande. Limite massimo: 10MB');
                return;
            }

            try {
                analysisFile = file;
                
                // Show file info
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
                
                // Process Excel file
                await processExcelFile(file);
                
            } catch (error) {
                console.error('Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        }

        async function processExcelFile(file) {
            try {
                const data = await readExcelFile(file);
                extractedData = extractKeyData(data);
                
                // Show preview
                displayExcelPreview(extractedData);
                
                // Enable generate button
                document.getElementById('fileGenerateBtn').disabled = false;
                
            } catch (error) {
                console.error('Errore nell\'elaborazione del file Excel:', error);
                alert('Errore nell\'elaborazione del file Excel: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        // Supporto per .xlsm (Excel con macro) e altri formati
                        const workbook = XLSX.read(data, { 
                            type: 'binary',
                            cellFormulas: false, // Ignora le formule per sicurezza
                            cellStyles: false,   // Non serve per l'estrazione dati
                            sheetStubs: true     // Include celle vuote
                        });
                        
                        const result = {};
                        workbook.SheetNames.forEach(sheetName => {
                            const sheet = workbook.Sheets[sheetName];
                            // Converti in JSON con header numerico per maggiore flessibilit√†
                            result[sheetName] = XLSX.utils.sheet_to_json(sheet, { 
                                header: 1,
                                defval: '',  // Valore default per celle vuote
                                raw: false   // Converti tutto in stringhe per parsing uniforme
                            });
                        });
                        
                        resolve(result);
                    } catch (error) {
                        reject(new Error(`Errore nel parsing del file Excel: ${error.message}`));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Errore nella lettura del file'));
                };
                
                reader.readAsBinaryString(file);
            });
        }

        function extractKeyData(excelData) {
            const extracted = {
                cliente: '',
                progetto: '',
                totaleOfferta: 0,
                margine: 0,
                marginePct: 0,
                timeline: '',
                componenti: [],
                servizi: [],
                righeComplete: [],
                headers: [],
                riepilogo: {},
                sheets: Object.keys(excelData),
                rawData: null,
                dataFound: false,
                numeroRighe: 0,
                numeroColonne: 0
            };

            // Cerca specificamente il foglio "Analisi Economica"
            const targetSheetNames = [
                'Analisi Economica',
                'analisi economica', 
                'ANALISI ECONOMICA',
                'Analisi_Economica',
                'AnalisiEconomica'
            ];

            let targetSheet = null;
            let sheetName = '';

            // Trova il foglio target
            for (const name of targetSheetNames) {
                if (excelData[name]) {
                    targetSheet = excelData[name];
                    sheetName = name;
                    extracted.dataFound = true;
                    break;
                }
            }

            if (!targetSheet) {
                // Se non trova il nome esatto, cerca fogli che contengono "analisi" ed "economica"
                for (const name of Object.keys(excelData)) {
                    const lowerName = name.toLowerCase();
                    if (lowerName.includes('analisi') && lowerName.includes('economica')) {
                        targetSheet = excelData[name];
                        sheetName = name;
                        extracted.dataFound = true;
                        break;
                    }
                }
            }

            if (!targetSheet) {
                console.warn('Foglio "Analisi Economica" non trovato. Fogli disponibili:', Object.keys(excelData));
                return extracted;
            }

            console.log(`Analizzando foglio: "${sheetName}"`);
            extracted.rawData = targetSheet;
            extracted.numeroRighe = targetSheet.length;
            extracted.numeroColonne = Math.max(...targetSheet.map(row => row ? row.length : 0));

            // === ESTRAZIONE HEADERS (prima riga significativa) ===
            let headerRowIndex = 0;
            for (let i = 0; i < Math.min(5, targetSheet.length); i++) {
                const row = targetSheet[i];
                if (row && row.some(cell => cell && cell.toString().trim())) {
                    if (row.some(cell => cell && (
                        cell.toString().toLowerCase().includes('descrizione') ||
                        cell.toString().toLowerCase().includes('quantit√†') ||
                        cell.toString().toLowerCase().includes('prezzo') ||
                        cell.toString().toLowerCase().includes('totale')
                    ))) {
                        headerRowIndex = i;
                        break;
                    }
                }
            }

            if (targetSheet[headerRowIndex]) {
                extracted.headers = targetSheet[headerRowIndex].map((cell, index) => ({
                    colonna: index + 1,
                    nome: cell ? cell.toString().trim() : `Colonna_${index + 1}`,
                    originale: cell ? cell.toString() : ''
                }));
            }

            // === ESTRAZIONE COMPLETA DI TUTTE LE RIGHE ===
            targetSheet.forEach((row, rowIndex) => {
                if (!row || rowIndex <= headerRowIndex) return;
                
                // Controlla se la riga ha contenuto significativo
                const hasContent = row.some(cell => cell && cell.toString().trim() && 
                    !cell.toString().toLowerCase().includes('totale generale'));

                if (hasContent) {
                    const rigaCompleta = {
                        numeroRiga: rowIndex + 1,
                        dati: {},
                        valoriGrezzi: [],
                        isComponente: false,
                        isServizio: false,
                        isTestata: false
                    };

                    // Estrai tutti i valori di ogni colonna
                    row.forEach((cell, colIndex) => {
                        const valore = cell ? cell.toString().trim() : '';
                        const nomeColonna = extracted.headers[colIndex]?.nome || `Col_${colIndex + 1}`;
                        
                        rigaCompleta.valoriGrezzi.push(valore);
                        rigaCompleta.dati[nomeColonna] = valore;
                        
                        // Mappatura specifica per colonne standard
                        rigaCompleta.dati[`colonna_${colIndex + 1}`] = valore;
                    });

                    // === ANALISI SPECIFICA DELLA TUA RIGA ESEMPIO ===
                    // Riga 3: 1 Auditorium Smart Room - Multimedia 0 ‚Äì Installazione/Sistemi Tecnologia EB-L630U Proiettore laser...
                    
                    // Identifica il tipo di riga
                    const primaColonna = rigaCompleta.valoriGrezzi[0] || '';
                    const secondaColonna = rigaCompleta.valoriGrezzi[1] || '';
                    
                    if (primaColonna && !isNaN(parseInt(primaColonna))) {
                        rigaCompleta.numeroProgressivo = parseInt(primaColonna);
                        rigaCompleta.isComponente = true;
                    }

                    // Estrazione strutturata per componenti/prodotti
                    if (rigaCompleta.isComponente) {
                        const componente = {
                            riga: rowIndex + 1,
                            numeroProgressivo: rigaCompleta.numeroProgressivo,
                            spazio: rigaCompleta.valoriGrezzi[1] || '',
                            tipologia: rigaCompleta.valoriGrezzi[2] || '',
                            categoria: rigaCompleta.valoriGrezzi[3] || '',
                            codice: '',
                            descrizione: '',
                            quantita: 0,
                            prezzoUnitario: 0,
                            prezzoTotale: 0,
                            costoUnitario: 0,
                            costoTotale: 0,
                            margineUnitario: 0,
                            margineTotale: 0,
                            moltiplicatore: 0,
                            valoriCompleti: rigaCompleta.valoriGrezzi
                        };

                        // Cerca codice e descrizione prodotto nelle colonne successive
                        for (let i = 3; i < rigaCompleta.valoriGrezzi.length; i++) {
                            const valore = rigaCompleta.valoriGrezzi[i];
                            if (valore) {
                                // Se sembra un codice prodotto (lettere+numeri, breve)
                                if (/^[A-Z0-9\-]{3,20}$/i.test(valore) && !componente.codice) {
                                    componente.codice = valore;
                                }
                                // Se sembra una descrizione (pi√π lunga, con spazi)
                                else if (valore.length > 10 && valore.includes(' ') && !componente.descrizione) {
                                    componente.descrizione = valore;
                                }
                                // Se √® un numero, potrebbe essere qty o prezzo
                                else if (!isNaN(parseFloat(valore.replace(/[‚Ç¨\s\.,]/g, '').replace(',', '.')))) {
                                    const numero = parseFloat(valore.replace(/[‚Ç¨\s\.,]/g, '').replace(',', '.'));
                                    
                                    if (numero <= 100 && componente.quantita === 0) {
                                        componente.quantita = numero;
                                    } else if (numero > 100) {
                                        if (componente.prezzoUnitario === 0) {
                                            componente.prezzoUnitario = numero;
                                        } else if (componente.prezzoTotale === 0) {
                                            componente.prezzoTotale = numero;
                                        } else if (componente.costoUnitario === 0) {
                                            componente.costoUnitario = numero;
                                        } else if (componente.costoTotale === 0) {
                                            componente.costoTotale = numero;
                                        } else if (componente.margineUnitario === 0) {
                                            componente.margineUnitario = numero;
                                        } else if (componente.margineTotale === 0) {
                                            componente.margineTotale = numero;
                                        }
                                    } else if (numero < 10 && numero > 0 && componente.moltiplicatore === 0) {
                                        componente.moltiplicatore = numero;
                                    }
                                }
                            }
                        }

                        extracted.componenti.push(componente);
                    }

                    // Cerca informazioni generali in tutte le righe
                    rigaCompleta.valoriGrezzi.forEach((valore, index) => {
                        if (!valore) return;
                        const valoreStr = valore.toString().toLowerCase();
                        
                        // Cliente
                        if (valoreStr.includes('cliente') || valoreStr.includes('customer')) {
                            const prossimoValore = rigaCompleta.valoriGrezzi[index + 1];
                            if (prossimoValore && !extracted.cliente) {
                                extracted.cliente = prossimoValore;
                            }
                        }
                        
                        // Progetto
                        if (valoreStr.includes('progetto') || valoreStr.includes('commessa')) {
                            const prossimoValore = rigaCompleta.valoriGrezzi[index + 1];
                            if (prossimoValore && !extracted.progetto) {
                                extracted.progetto = prossimoValore;
                            }
                        }
                    });

                    extracted.righeComplete.push(rigaCompleta);
                }
            });

            // === CALCOLI RIEPILOGATIVI ===
            extracted.riepilogo = {
                numeroRigheAnalizzate: extracted.righeComplete.length,
                numeroComponenti: extracted.componenti.length,
                numeroServizi: extracted.servizi.length,
                valoreComponenti: extracted.componenti.reduce((sum, comp) => sum + (comp.prezzoTotale || 0), 0),
                costoTotaleComponenti: extracted.componenti.reduce((sum, comp) => sum + (comp.costoTotale || 0), 0),
                margineTotaleComponenti: extracted.componenti.reduce((sum, comp) => sum + (comp.margineTotale || 0), 0),
                spazi: [...new Set(extracted.componenti.map(c => c.spazio).filter(s => s))],
                tipologie: [...new Set(extracted.componenti.map(c => c.tipologia).filter(t => t))],
                categorie: [...new Set(extracted.componenti.map(c => c.categoria).filter(c => c))]
            };

            console.log('Estrazione completa terminata:', extracted);
            return extracted;
        }

        function extractComponentsTable(sheet, startRow, startCol) {
            const components = [];
            let headerRow = null;
            
            // Trova la riga header (cerca colonne tipiche)
            for (let row = startRow; row < Math.min(startRow + 3, sheet.length); row++) {
                const rowData = sheet[row];
                if (!rowData) continue;
                
                const headers = rowData.map(cell => (cell || '').toString().toLowerCase());
                if (headers.some(h => h.includes('qty') || h.includes('quantit√†') || h.includes('prezzo') || h.includes('price'))) {
                    headerRow = row;
                    break;
                }
            }
            
            if (!headerRow) headerRow = startRow;
            
            // Estrai componenti dalle righe successive
            for (let row = headerRow + 1; row < Math.min(headerRow + 50, sheet.length); row++) {
                const rowData = sheet[row];
                if (!rowData || rowData.length < 2) continue;
                
                // Stop se riga vuota o totali
                const firstCell = (rowData[0] || '').toString().toLowerCase();
                if (!firstCell || firstCell.includes('totale') || firstCell.includes('subtotal')) {
                    break;
                }
                
                const component = {
                    riga: row + 1,
                    codice: rowData[0] ? rowData[0].toString().trim() : '',
                    descrizione: rowData[1] ? rowData[1].toString().trim() : '',
                    quantita: 1,
                    prezzoUnitario: 0,
                    prezzoTotale: 0
                };
                
                // Cerca quantit√† e prezzi nelle colonne successive
                for (let col = 2; col < rowData.length; col++) {
                    const cellValue = rowData[col];
                    if (cellValue && !isNaN(parseFloat(cellValue))) {
                        const numValue = parseFloat(cellValue);
                        
                        if (numValue < 100 && component.quantita === 1) {
                            component.quantita = numValue;
                        } else if (numValue > 0) {
                            if (component.prezzoUnitario === 0) {
                                component.prezzoUnitario = numValue;
                            } else {
                                component.prezzoTotale = numValue;
                            }
                        }
                    }
                }
                
                // Calcola prezzo totale se mancante
                if (component.prezzoTotale === 0 && component.prezzoUnitario > 0) {
                    component.prezzoTotale = component.prezzoUnitario * component.quantita;
                }
                
                if (component.descrizione) {
                    components.push(component);
                }
            }
            
            return components;
        }

        function extractServicesTable(sheet, startRow, startCol) {
            const services = [];
            
            // Simile a extractComponentsTable ma per servizi
            for (let row = startRow + 1; row < Math.min(startRow + 20, sheet.length); row++) {
                const rowData = sheet[row];
                if (!rowData || rowData.length < 2) continue;
                
                const firstCell = (rowData[0] || '').toString().toLowerCase();
                if (!firstCell || firstCell.includes('totale')) break;
                
                const service = {
                    riga: row + 1,
                    descrizione: rowData[0] ? rowData[0].toString().trim() : '',
                    tipo: rowData[1] ? rowData[1].toString().trim() : '',
                    durata: '',
                    prezzo: 0
                };
                
                // Cerca prezzi
                for (let col = 1; col < rowData.length; col++) {
                    const cellValue = rowData[col];
                    if (cellValue && !isNaN(parseFloat(cellValue))) {
                        service.prezzoTotale = parseFloat(cellValue);
                        break;
                    }
                }
                
                if (service.descrizione) {
                    services.push(service);
                }
            }
            
            return services;
        }

        function removeDuplicateComponents(components) {
            const seen = new Set();
            return components.filter(comp => {
                const key = comp.descrizione + '_' + comp.codice;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function removeDuplicateServices(services) {
            const seen = new Set();
            return services.filter(serv => {
                const key = serv.descrizione;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        function displayExcelPreview(data) {
            const previewContainer = document.getElementById('excelPreviewContent');
            
            let html = '<div class="space-y-4">';
            
            // Status estrazione
            if (!data.dataFound) {
                html += `<div class="bg-red-50 p-3 rounded border border-red-200">`;
                html += `<strong class="text-red-800">‚ö†Ô∏è Foglio "Analisi Economica" non trovato</strong><br>`;
                html += `<span class="text-red-600">Fogli disponibili: ${data.sheets.join(', ')}</span><br>`;
                html += `<span class="text-xs text-red-500">Verifica che il file contenga un foglio denominato "Analisi Economica"</span>`;
                html += `</div>`;
                html += '</div>';
                previewContainer.innerHTML = html;
                document.getElementById('excelDataPreview').classList.remove('hidden');
                return;
            }
            
            // Stats generali
            html += `<div class="bg-blue-50 p-4 rounded border border-blue-200">`;
            html += `<strong class="text-blue-800">üìä Analisi Completa Foglio "Analisi Economica":</strong><br><br>`;
            html += `<div class="grid grid-cols-3 gap-4 text-sm">`;
            html += `<div><strong>Righe Totali:</strong> ${data.numeroRighe}</div>`;
            html += `<div><strong>Colonne Max:</strong> ${data.numeroColonne}</div>`;
            html += `<div><strong>Righe Analizzate:</strong> ${data.righeComplete.length}</div>`;
            html += `<div><strong>Headers Trovati:</strong> ${data.headers.length}</div>`;
            html += `<div><strong>Componenti:</strong> ${data.componenti.length}</div>`;
            html += `<div><strong>Cliente:</strong> ${data.cliente || 'Non trovato'}</div>`;
            html += `</div></div>`;
            
            // Headers del foglio
            if (data.headers.length > 0) {
                html += `<div class="bg-purple-50 p-4 rounded border border-purple-200">`;
                html += `<strong class="text-purple-800">üìã Headers/Colonne Rilevate:</strong><br><br>`;
                html += `<div class="grid grid-cols-3 gap-2 text-xs">`;
                data.headers.slice(0, 12).forEach(header => {
                    html += `<div class="bg-white p-1 rounded border">Col ${header.colonna}: ${header.nome}</div>`;
                });
                if (data.headers.length > 12) {
                    html += `<div class="text-center text-gray-500">... e altre ${data.headers.length - 12} colonne</div>`;
                }
                html += `</div></div>`;
            }
            
            // Componenti dettagliati 
            if (data.componenti.length > 0) {
                html += `<div class="bg-green-50 p-4 rounded border border-green-200">`;
                html += `<strong class="text-green-800">üõ†Ô∏è Componenti Estratti (${data.componenti.length}):</strong><br><br>`;
                html += `<div class="space-y-3 max-h-40 overflow-y-auto">`;
                data.componenti.slice(0, 5).forEach((comp, index) => {
                    html += `<div class="bg-white p-3 rounded border text-xs">`;
                    html += `<div class="grid grid-cols-2 gap-2">`;
                    html += `<div><strong>Riga ${comp.riga} - #${comp.numeroProgressivo}:</strong> ${comp.descrizione || 'Descrizione non trovata'}</div>`;
                    html += `<div><strong>Codice:</strong> ${comp.codice || 'N/A'}</div>`;
                    html += `<div><strong>Spazio:</strong> ${comp.spazio}</div>`;
                    html += `<div><strong>Tipologia:</strong> ${comp.tipologia}</div>`;
                    html += `<div><strong>Categoria:</strong> ${comp.categoria}</div>`;
                    html += `<div><strong>Qty:</strong> ${comp.quantita}</div>`;
                    html += `<div><strong>Prezzo Unit.:</strong> ‚Ç¨${comp.prezzoUnitario.toLocaleString()}</div>`;
                    html += `<div><strong>Prezzo Tot.:</strong> ‚Ç¨${comp.prezzoTotale.toLocaleString()}</div>`;
                    html += `<div><strong>Costo Unit.:</strong> ‚Ç¨${comp.costoUnitario.toLocaleString()}</div>`;
                    html += `<div><strong>Margine Tot.:</strong> ‚Ç¨${comp.margineTotale.toLocaleString()}</div>`;
                    html += `</div>`;
                    html += `<div class="mt-2 text-gray-600"><strong>Dati grezzi:</strong> ${comp.valoriCompleti.slice(0, 8).join(' | ')}${comp.valoriCompleti.length > 8 ? '...' : ''}</div>`;
                    html += `</div>`;
                });
                if (data.componenti.length > 5) {
                    html += `<div class="text-center text-gray-500 py-2">... e altri ${data.componenti.length - 5} componenti</div>`;
                }
                html += `</div></div>`;
            }
            
            // Riepilogo economico dettagliato
            if (data.riepilogo) {
                html += `<div class="bg-yellow-50 p-4 rounded border border-yellow-200">`;
                html += `<strong class="text-yellow-800">üí∞ Riepilogo Completo:</strong><br><br>`;
                html += `<div class="grid grid-cols-2 gap-4 text-sm">`;
                html += `<div>`;
                html += `<strong>Dati Numerici:</strong><br>`;
                html += `‚Ä¢ Righe analizzate: ${data.riepilogo.numeroRigheAnalizzate}<br>`;
                html += `‚Ä¢ Componenti trovati: ${data.riepilogo.numeroComponenti}<br>`;
                html += `‚Ä¢ Valore componenti: ‚Ç¨${data.riepilogo.valoreComponenti.toLocaleString()}<br>`;
                html += `‚Ä¢ Costo totale: ‚Ç¨${data.riepilogo.costoTotaleComponenti.toLocaleString()}<br>`;
                html += `‚Ä¢ Margine totale: ‚Ç¨${data.riepilogo.margineTotaleComponenti.toLocaleString()}`;
                html += `</div>`;
                html += `<div>`;
                html += `<strong>Spazi identificati:</strong><br>`;
                if (data.riepilogo.spazi.length > 0) {
                    data.riepilogo.spazi.slice(0, 5).forEach(spazio => {
                        html += `‚Ä¢ ${spazio}<br>`;
                    });
                    if (data.riepilogo.spazi.length > 5) {
                        html += `... e altri ${data.riepilogo.spazi.length - 5}`;
                    }
                } else {
                    html += `Nessuno spazio identificato`;
                }
                html += `</div>`;
                html += `</div></div>`;
            }
            
            // Prime 3 righe complete come esempio
            if (data.righeComplete.length > 0) {
                html += `<div class="bg-gray-50 p-4 rounded border">`;
                html += `<strong class="text-gray-800">üîç Esempio Prime Righe Complete:</strong><br><br>`;
                html += `<div class="space-y-2 text-xs max-h-32 overflow-y-auto">`;
                data.righeComplete.slice(0, 3).forEach(riga => {
                    html += `<div class="bg-white p-2 rounded border">`;
                    html += `<strong>Riga ${riga.numeroRiga}:</strong> ${riga.valoriGrezzi.slice(0, 10).join(' | ')}${riga.valoriGrezzi.length > 10 ? '...' : ''}`;
                    html += `</div>`;
                });
                html += `</div></div>`;
            }
            
            html += '</div>';
            
            previewContainer.innerHTML = html;
            document.getElementById('excelDataPreview').classList.remove('hidden');
        }‚Ä¢ ${serv.descrizione} - ‚Ç¨${serv.prezzoTotale?.toLocaleString() || '0'}<br>`;
                });
                if (data.servizi.length > 5) {
                    html += `... e altri ${data.servizi.length - 5} servizi`;
                }
                html += `</div></div>`;
            }
            
            // Riepilogo economico
            if (data.riepilogo) {
                html += `<div class="bg-yellow-50 p-4 rounded border border-yellow-200">`;
                html += `<strong class="text-yellow-800">üí∞ Riepilogo Economico:</strong><br><br>`;
                html += `<div class="grid grid-cols-2 gap-2 text-xs">`;
                html += `<div>Componenti: ${data.riepilogo.numeroComponenti} (‚Ç¨${data.riepilogo.valoreComponenti.toLocaleString()})</div>`;
                html += `<div>Servizi: ${data.riepilogo.numeroServizi} (‚Ç¨${data.riepilogo.valoreServizi.toLocaleString()})</div>`;
                html += `<div>Totale calcolato: ‚Ç¨${(data.riepilogo.valoreComponenti + data.riepilogo.valoreServizi).toLocaleString()}</div>`;
                html += `<div>Margine rilevato: ‚Ç¨${data.margine.toLocaleString()}</div>`;
                html += `</div></div>`;
            }
            
            // Info debug
            html += `<div class="bg-gray-50 p-3 rounded border text-xs text-gray-600">`;
            html += `<strong>‚ÑπÔ∏è Info Estrazione:</strong> Analizzato foglio "Analisi Economica" | `;
            html += `${data.rawData ? data.rawData.length : 0} righe processate | `;
            html += `Estrazione completata con successo`;
            html += `</div>`;
            
            html += '</div>';
            
            previewContainer.innerHTML = html;
            document.getElementById('excelDataPreview').classList.remove('hidden');
        }

        function removeAnalysisFile() {
            analysisFile = null;
            extractedData = {};
            document.getElementById('uploadedAnalysisFile').classList.add('hidden');
            document.getElementById('excelDataPreview').classList.add('hidden');
            document.getElementById('analysisUpload').value = '';
            document.getElementById('fileGenerateBtn').disabled = true;
        }

        async function generateFiles() {
            // Validation
            const clientName = document.getElementById('fileGenClientName').value.trim();
            if (!clientName || !analysisFile) {
                alert('Compila il nome cliente e carica il file di analisi economica');
                return;
            }

            const generateOffer = document.getElementById('generateOffer').checked;
            const generateSummary = document.getElementById('generateSummary').checked;
            const generateCRM = document.getElementById('generateCRM').checked;

            if (!generateOffer && !generateSummary && !generateCRM) {
                alert('Seleziona almeno un tipo di file da generare');
                return;
            }

            // Show loading
            const btn = document.getElementById('fileGenerateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `
                <svg class="w-5 h-5 mr-3 loading" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Generazione in corso...
            `;
            btn.disabled = true;

            try {
                const projectData = {
                    cliente: clientName,
                    projectCode: document.getElementById('projectCode').value,
                    salesManager: document.getElementById('salesManager').value,
                    commercialNotes: document.getElementById('commercialNotes').value,
                    clientContacts: document.getElementById('clientContacts').value,
                    offerExpiry: document.getElementById('offerExpiry').value,
                    paymentTerms: document.getElementById('paymentTerms').value,
                    projectPriority: document.getElementById('projectPriority').value,
                    extractedData: extractedData
                };

                generatedFilesData = [];

                if (generateOffer) {
                    const offerContent = await generateCommercialOffer(projectData);
                    generatedFilesData.push({
                        type: 'offer',
                        name: `Offerta_Commerciale_${clientName.replace(/\s+/g, '_')}.docx`,
                        content: offerContent,
                        icon: 'document',
                        color: 'blue'
                    });
                }

                if (generateSummary) {
                    const summaryContent = await generateExecutiveSummary(projectData);
                    generatedFilesData.push({
                        type: 'summary',
                        name: `Sintesi_Progetto_${clientName.replace(/\s+/g, '_')}.pdf`,
                        content: summaryContent,
                        icon: 'document-text',
                        color: 'purple'
                    });
                }

                if (generateCRM) {
                    const crmContent = await generateCRMFile(projectData);
                    generatedFilesData.push({
                        type: 'crm',
                        name: `CRM_Data_${clientName.replace(/\s+/g, '_')}.xlsx`,
                        content: crmContent,
                        icon: 'table',
                        color: 'green'
                    });
                }

                displayGeneratedFiles();
                
                document.getElementById('fileGeneratorForm').classList.add('hidden');
                document.getElementById('generatedFiles').classList.remove('hidden');
                document.getElementById('generatedFiles').classList.add('fade-in');

            } catch (error) {
                alert('Errore nella generazione dei file: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function generateCommercialOffer(projectData) {
            const prompt = `Genera un'offerta commerciale professionale in formato Word per Var Group - Multimedia & Workspaces.

DATI PROGETTO:
Cliente: ${projectData.cliente}
Codice Progetto: ${projectData.projectCode}
Sales Manager: ${projectData.salesManager}
Scadenza Offerta: ${projectData.offerExpiry}
Modalit√† Pagamento: ${projectData.paymentTerms}
Note Commerciali: ${projectData.commercialNotes}

DATI ECONOMICI:
Totale Offerta: ‚Ç¨${projectData.extractedData.totaleOfferta.toLocaleString()}
Margine: ${projectData.extractedData.margine}
Componenti: ${projectData.extractedData.componenti.length} articoli

COMPONENTI PRINCIPALI:
${projectData.extractedData.componenti.slice(0, 10).map(c => `- ${c.descrizione} (Qty: ${c.quantita})`).join('\n')}

Crea un'offerta commerciale strutturata con:
1. Header Var Group con loghi e dati aziendali
2. Executive Summary del progetto
3. Tabella dettagliata componenti con prezzi
4. Condizioni commerciali e modalit√† di pagamento
5. Vantaggi competitivi e valore aggiunto
6. Timeline implementazione
7. Termini e condizioni

Formato: HTML pronto per conversione Word, professionale e branded Var Group.`;

            return await callGeminiAPI(prompt);
        }

        async function generateExecutiveSummary(projectData) {
            const prompt = `Crea una sintesi esecutiva del progetto per ${projectData.cliente}.

DATI PROGETTO:
- Valore totale: ‚Ç¨${projectData.extractedData.totaleOfferta.toLocaleString()}
- Margine: ${projectData.extractedData.margine}
- Componenti: ${projectData.extractedData.componenti.length}
- Priorit√†: ${projectData.projectPriority}

Crea una sintesi di 2 pagine con:
1. Overview progetto e obiettivi
2. Soluzione proposta (high-level)
3. Investimento e ROI
4. Timeline e milestone
5. Rischi e mitigation
6. Next steps

Formato: HTML per PDF, executive-level, conciso ma completo.`;

            return await callGeminiAPI(prompt);
        }

        async function generateCRMFile(projectData) {
            // Generate structured data for CRM
            const crmData = {
                cliente: projectData.cliente,
                opportunita: `MW_${projectData.projectCode}_${new Date().getFullYear()}`,
                valore: projectData.extractedData.totaleOfferta,
                margine: projectData.extractedData.margine,
                salesManager: projectData.salesManager,
                dataCreazione: new Date().toISOString().split('T')[0],
                scadenzaOfferta: projectData.offerExpiry,
                priorita: projectData.projectPriority,
                stato: 'Proposta Inviata',
                note: projectData.commercialNotes,
                componenti: projectData.extractedData.componenti.length
            };

            return JSON.stringify(crmData, null, 2);
        }

        function displayGeneratedFiles() {
            const filesList = document.getElementById('filesList');
            const filesPreview = document.getElementById('filesPreview');
            
            // Files list
            let filesHTML = '';
            generatedFilesData.forEach((file, index) => {
                const iconPath = getIconPath(file.icon);
                filesHTML += `
                    <div class="border border-${file.color}-200 rounded-lg p-4 bg-${file.color}-50">
                        <div class="flex items-center mb-3">
                            ${iconPath}
                            <span class="font-medium text-${file.color}-800 ml-2">${getFileTypeLabel(file.type)}</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">${file.name}</p>
                        <div class="flex gap-2">
                            <button onclick="downloadFile(${index})" class="flex-1 px-3 py-2 bg-${file.color}-600 text-white text-xs rounded hover:bg-${file.color}-700">
                                Download
                            </button>
                            <button onclick="previewFile(${index})" class="flex-1 px-3 py-2 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300">
                                Anteprima
                            </button>
                        </div>
                    </div>
                `;
            });
            
            filesList.innerHTML = filesHTML;
        }

        function getIconPath(iconType) {
            const icons = {
                'document': `<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'document-text': `<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'table': `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h12a1 1 0 011 1v16a1 1 0 01-1 1H4a1 1 0 01-1-1z"></path></svg>`
            };
            return icons[iconType] || icons['document'];
        }

        function getFileTypeLabel(type) {
            const labels = {
                'offer': 'Offerta Commerciale',
                'summary': 'Sintesi Progetto', 
                'crm': 'Dati CRM'
            };
            return labels[type] || type;
        }

        function downloadFile(index) {
            const file = generatedFilesData[index];
            
            let mimeType, dataUrl;
            
            if (file.type === 'crm') {
                // JSON to Excel conversion
                const ws = XLSX.utils.json_to_sheet([JSON.parse(file.content)]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "CRM_Data");
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                dataUrl = URL.createObjectURL(blob);
            } else {
                // HTML content
                const blob = new Blob([file.content], { type: 'text/html' });
                dataUrl = URL.createObjectURL(blob);
            }
            
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(dataUrl);
        }

        function previewFile(index) {
            const file = generatedFilesData[index];
            const previewContainer = document.getElementById('filesPreview');
            
            let previewHTML = `
                <div class="bg-white border rounded-lg p-6">
                    <h4 class="font-medium text-gray-800 mb-4">Anteprima: ${file.name}</h4>
                    <div class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto">
            `;
            
            if (file.type === 'crm') {
                const data = JSON.parse(file.content);
                previewHTML += '<pre class="text-sm">' + JSON.stringify(data, null, 2) + '</pre>';
            } else {
                previewHTML += file.content.substring(0, 2000) + (file.content.length > 2000 ? '...' : '');
            }
            
            previewHTML += `
                    </div>
                </div>
            `;
            
            previewContainer.innerHTML = previewHTML;
        }

        function downloadAllFiles() {
            generatedFilesData.forEach((file, index) => {
                setTimeout(() => downloadFile(index), index * 1000); // Stagger downloads
            });
        }

        function resetFileGenerator() {
            // Reset all form fields
            document.getElementById('fileGenClientName').value = '';
            document.getElementById('projectCode').value = '';
            document.getElementById('salesManager').value = '';
            document.getElementById('commercialNotes').value = '';
            document.getElementById('clientContacts').value = '';
            document.getElementById('offerExpiry').value = '';
            document.getElementById('paymentTerms').value = '';
            document.getElementById('projectPriority').value = 'standard';
            
            // Reset checkboxes
            document.getElementById('generateOffer').checked = true;
            document.getElementById('generateSummary').checked = true;
            document.getElementById('generateCRM').checked = true;
            
            // Reset file state
            removeAnalysisFile();
            generatedFilesData = [];
            
            // Show form, hide results
            document.getElementById('fileGeneratorForm').classList.remove('hidden');
            document.getElementById('generatedFiles').classList.add('hidden');
        }

        // Call Gemini API
        async function callGeminiAPI(prompt) {
            const modelName = "gemini-2.5-pro";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;

            const requestBody = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody),
            });
            
            if (!response.ok) {
                throw new Error(`API Error (${response.status}): ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                let rawText = result.candidates[0].content.parts[0].text;
                return rawText.replace(/^\s*```(html)?\n?/, '').replace(/\n?```\s*$/, '');
            } else {
                throw new Error("Risposta AI non nel formato atteso.");
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default view
            showIntro();
            
            // Add click handler for home button
            document.getElementById('homeBtn').addEventListener('click', showIntro);
            
            // Set default dates
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('offerExpiry').value = tomorrow.toISOString().split('T')[0];
            
            // Disable generate button initially
            document.getElementById('fileGenerateBtn').disabled = true;
        });
    </script>
</body>
</html>
