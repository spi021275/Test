<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA sfruttando l'expertise di 51 anni, partnership certificate e soluzioni proprietarie.</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Module 3 - UPDATED -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generazione File</h3>
                            <p class="text-gray-600 mb-4">Trasforma l'Analisi Economica DSA in offerta commerciale, sintesi dati e file CRM pronti all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module (EXISTING) -->
        <div id="postMeetingSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>

                <h2 class="text-3xl font-bold text-gray-900 mb-2">Analizza Meeting & Genera Brief DSA</h2>
                <p class="text-gray-600 mb-8">Trasforma i tuoi appunti del meeting in un brief tecnico strutturato per il team DSA utilizzando l'expertise completa della BU (51 anni esperienza, 823M€ fatturato, 3.850 persone)</p>

                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 1 - Funzionalità esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- Space Wizard Module (EXISTING) -->
        <div id="spaceWizardSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>

                <h2 class="text-3xl font-bold text-gray-900 mb-2">Wizard Spazi Collaborativi</h2>
                <p class="text-gray-600 mb-8">Configura la soluzione tecnologica ottimale per il tuo spazio con analisi AI automatica da foto/planimetrie o inserimento manuale</p>

                <div class="text-center py-12">
                    <p class="text-gray-500">Modulo 2 - Funzionalità esistente mantenuta</p>
                </div>
            </div>
        </div>

        <!-- File Generator Module - UPDATED -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Torna alla Homepage
                </button>

                <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione File da Analisi Economica DSA</h2>
                <p class="text-gray-600 mb-8">Carica il file Excel "Analisi Economica" dal DSA e genera automaticamente offerta commerciale, sintesi dati e file CRM</p>

                <div id="fileGeneratorForm" class="space-y-8">

                    <!-- Dati Base Progetto -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. JBT Corporation">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto</label>
                            <input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. PRJ-2024-001">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sales Manager VAR</label>
                            <input type="text" id="salesManager" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Es. Mario Rossi">
                        </div>
                    </div>

                    <!-- Upload Analisi Economica -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-green-300 border-dashed rounded-lg bg-green-50 hover:bg-green-100 cursor-pointer transition-colors">
                                <svg class="w-10 h-10 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <span class="text-sm text-green-700 font-medium">Carica Analisi Economica DSA</span>
                                <span class="text-xs text-green-600 mt-1">.xlsx, .xlsm, .xls (max 10MB)</span>
                            </div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls" onchange="handleAnalysisUpload(event)">

                            <!-- Uploaded File Display -->
                            <div id="uploadedAnalysisFile" class="mt-4 hidden">
                                <div class="flex items-center justify-between bg-green-100 p-3 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span id="analysisFileName" class="font-medium text-green-800"></span>
                                    </div>
                                    <button onclick="removeAnalysisFile()" class="text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Excel Data Preview -->
                            <div id="excelDataPreview" class="mt-4 hidden">
                                <h4 class="font-medium text-gray-800 mb-2">Anteprima Dati Estratti</h4>
                                <div class="bg-white p-4 rounded-lg border max-h-60 overflow-y-auto">
                                    <div id="excelPreviewContent" class="text-sm text-gray-700"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configurazione Output -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File da Generare</label>
                        <div class="grid md:grid-cols-3 gap-4">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateOffer" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Offerta Commerciale Word</span>
                                    <p class="text-xs text-gray-600 mt-1">Per Sales Manager VAR</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateSummary" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">Sintesi Dati PDF</span>
                                    <p class="text-xs text-gray-600 mt-1">Executive summary progetto</p>
                                </div>
                            </label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 border-green-200 bg-green-50">
                                <input type="checkbox" id="generateCRM" class="mr-3 text-green-600" checked>
                                <div>
                                    <span class="font-medium text-gray-800">File Excel CRM</span>
                                    <p class="text-xs text-gray-600 mt-1">Dati strutturati per caricamento CRM</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Parametri Personalizzazione -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-4">Personalizzazione Output</h4>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Note Commerciali</label>
                                <textarea id="commercialNotes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Note aggiuntive per l'offerta commerciale..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contatti Cliente</label>
                                <textarea id="clientContacts" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Referenti cliente, email, telefoni..."></textarea>
                            </div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mt-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Scadenza Offerta</label>
                                <input type="date" id="offerExpiry" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Modalità Pagamento</label>
                                <select id="paymentTerms" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="">Seleziona...</option>
                                    <option value="30gg">30 giorni fine mese</option>
                                    <option value="60gg">60 giorni fine mese</option>
                                    <option value="90gg">90 giorni fine mese</option>
                                    <option value="custom">Personalizzato</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Priorità Progetto</label>
                                <select id="projectPriority" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="standard">Standard</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Critica</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="text-center">
                        <button type="button" onclick="generateFiles()" id="fileGenerateBtn" class="inline-flex items-center px-8 py-3 bg-green-600 text-white font-medium text-lg rounded-lg hover:bg-green-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Genera File
                        </button>
                    </div>
                </div>

                <!-- Generated Files Display -->
                <div id="generatedFiles" class="hidden space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">File Generati</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="downloadAllFiles()" class="inline-flex items-center px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Tutti i File
                            </button>
                            <button onclick="resetFileGenerator()" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Nuova Generazione
                            </button>
                        </div>
                    </div>

                    <!-- Files List -->
                    <div id="filesList" class="grid md:grid-cols-3 gap-6">
                        <!-- Generated files will be displayed here -->
                    </div>

                    <!-- File Contents Preview -->
                    <div id="filesPreview" class="space-y-6">
                        <!-- File previews will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="mt-16 pb-8 text-center text-sm text-gray-500">
        <p>
            Strumento specializzato per la BU Multimedia & Workspaces di
            <span class="font-semibold text-blue-600">Var Group</span>
        </p>
        <p class="mt-2 text-xs text-gray-400 max-w-2xl mx-auto px-4">
            Alimentato dall'expertise di 51 anni, 823M€ fatturato, 3.850 persone, partnership certificate e soluzioni proprietarie
        </p>
    </div>

    <script>
        // State management
        let analysisFile = null;
        let extractedData = {};
        let generatedFilesData = [];

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showPostMeeting() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.remove('hidden');
            // ...
        }

        function showSpaceWizard() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.remove('hidden');
            // ...
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('postMeetingSection').classList.add('hidden');
            document.getElementById('spaceWizardSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // File Generator Functions
        async function handleAnalysisUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xlsm') && !file.name.toLowerCase().endsWith('.xls')) {
                alert('Seleziona solo file Excel (.xlsx, .xlsm o .xls)');
                return;
            }

            try {
                analysisFile = file;
                document.getElementById('analysisFileName').textContent = file.name;
                document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
                await processExcelFile(file);
            } catch (error) {
                console.error('Errore nel caricamento del file:', error);
                alert('Errore nel caricamento del file: ' + error.message);
            }
        }

        async function processExcelFile(file) {
            try {
                const data = await readExcelFile(file);
                extractedData = extractKeyData(data);
                displayExcelPreview(extractedData);
                document.getElementById('fileGenerateBtn').disabled = false;
            } catch (error) {
                console.error('Errore nell\'elaborazione del file Excel:', error);
                alert('Errore nell\'elaborazione del file Excel: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }));
                    } catch (error) {
                        reject(new Error(`Errore nel parsing del file Excel: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error('Errore nella lettura del file'));
                reader.readAsBinaryString(file);
            });
        }

        // *** MODIFIED FUNCTION ***
        function extractKeyData(sheetData) {
            const extracted = { articoli: [], errori: [] };
            if (!sheetData || sheetData.length < 3) {
                extracted.errori.push("Il foglio Excel sembra vuoto.");
                return extracted;
            }

            const colonne = {
                codiceProduttore_I: 8,
                descrizione_J: 9,
                quantita_K: 10,
                venditaUnitario_T: 19,
                venditaTotale_U: 20,
            };

            for (let i = 2; i < sheetData.length; i++) {
                const row = sheetData[i];
                // Includi la riga se c'è un valore in una delle colonne chiave (es. J o K)
                if (row && (row[colonne.descrizione_J] || row[colonne.quantita_K])) {
                    extracted.articoli.push({
                        descrizioneCombinata: `${row[colonne.codiceProduttore_I] || ''} - ${row[colonne.descrizione_J] || ''}`,
                        quantitaK: parseFloat(row[colonne.quantita_K]) || 0,
                        venditaUnitarioT: parseFloat(row[colonne.venditaUnitario_T]) || 0,
                        venditaTotaleU: parseFloat(row[colonne.venditaTotale_U]) || 0,
                    });
                }
            }

            extracted.totaleVenditaU = extracted.articoli.reduce((sum, art) => sum + art.venditaTotaleU, 0);
            return extracted;
        }

        function displayExcelPreview(data) {
            const previewContainer = document.getElementById('excelPreviewContent');
            let html = '<div class="space-y-3">';
            if (data.errori.length > 0) {
                html += `<div class="bg-red-50 p-3 rounded border border-red-200"><strong class="text-red-800">Avvisi:</strong><br>${data.errori.join('<br>')}</div>`;
            }
            html += `<div class="bg-blue-50 p-3 rounded border"><strong>Riepiloghi Totali:</strong><br>Articoli Estratti: <strong>${data.articoli.length}</strong><br>Totale Vendita (U): <strong>€${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></div>`;
            html += '</div>';
            previewContainer.innerHTML = html;
            document.getElementById('excelDataPreview').classList.remove('hidden');
        }

        function removeAnalysisFile() {
            analysisFile = null;
            extractedData = {};
            document.getElementById('uploadedAnalysisFile').classList.add('hidden');
            document.getElementById('excelDataPreview').classList.add('hidden');
            document.getElementById('analysisUpload').value = '';
            document.getElementById('fileGenerateBtn').disabled = true;
        }

        async function generateFiles() {
            const btn = document.getElementById('fileGenerateBtn');
            btn.disabled = true;
            btn.innerHTML = `<svg class="w-5 h-5 mr-3 loading" ...></svg>Generazione...`;

            const projectData = {
                cliente: document.getElementById('fileGenClientName').value,
                projectCode: document.getElementById('projectCode').value,
                salesManager: document.getElementById('salesManager').value,
                commercialNotes: document.getElementById('commercialNotes').value,
                offerExpiry: document.getElementById('offerExpiry').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                extractedData: extractedData
            };

            generatedFilesData = [];
            if (document.getElementById('generateOffer').checked) {
                generatedFilesData.push({ type: 'offer', name: `Offerta_${projectData.cliente.replace(/\s+/g, '_')}.docx`, content: generateCommercialOffer(projectData), icon: 'document', color: 'blue' });
            }
            if (document.getElementById('generateSummary').checked) {
                generatedFilesData.push({ type: 'summary', name: `Sintesi_${projectData.cliente.replace(/\s+/g, '_')}.pdf`, content: generateExecutiveSummary(projectData), icon: 'document-text', color: 'purple' });
            }
            if (document.getElementById('generateCRM').checked) {
                generatedFilesData.push({ type: 'crm', name: `CRM_${projectData.cliente.replace(/\s+/g, '_')}.xlsx`, content: generateCRMFile(projectData), icon: 'table', color: 'green' });
            }

            displayGeneratedFiles();
            document.getElementById('fileGeneratorForm').classList.add('hidden');
            document.getElementById('generatedFiles').classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = `<svg ...></svg>Genera File`;
        }

        // *** MODIFIED FUNCTION AS REQUESTED ***
        function generateCommercialOffer(projectData) {
            const data = projectData.extractedData;
            const dataOdierna = new Date().toLocaleDateString('it-IT');

            return `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;margin:40px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;text-align:left;}th{background-color:#f2f2f2;}.amount{text-align:right;}</style></head><body>
            <h1>Offerta Commerciale</h1>
            <p><strong>Cliente:</strong> ${projectData.cliente || 'N/D'}</p>
            <p><strong>Data:</strong> ${dataOdierna}</p>
            <p><strong>Rif:</strong> ${projectData.projectCode || 'N/D'}</p>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>Quantità</th>
                        <th>Descrizione</th>
                        <th>Prezzo Unitario</th>
                        <th>Prezzo Totale</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.articoli.map(art => `
                    <tr>
                        <td>${art.quantitaK}</td>
                        <td>${art.descrizioneCombinata}</td>
                        <td class="amount">€ ${art.venditaUnitarioT.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                        <td class="amount">€ ${art.venditaTotaleU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    </tr>`).join('')}
                    <tr style="font-weight:bold;">
                        <td colspan="3" class="amount">TOTALE</td>
                        <td class="amount">€ ${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    </tr>
                </tbody>
            </table>
            </body></html>`;
        }
        
        // This function remains from the base code you provided
        async function generateExecutiveSummary(projectData) {
            const data = projectData.extractedData;
             return `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body><h1>Sintesi Progetto per ${projectData.cliente}</h1><p>Totale Offerta: € ${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</p><ul>${data.articoli.map(art => `<li>${art.quantitaK} x ${art.descrizioneCombinata}</li>`).join('')}</ul></body></html>`;
        }

        // This function remains from the base code you provided
        async function generateCRMFile(projectData) {
            const data = projectData.extractedData;
            const crmData = {
                cliente: projectData.cliente,
                valoreOfferta: data.totaleVenditaU,
                articoli: data.articoli.map(a => a.descrizioneCombinata)
            };
            return JSON.stringify(crmData, null, 2);
        }

        function displayGeneratedFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            generatedFilesData.forEach((file, index) => {
                const iconPath = getIconPath(file.icon);
                filesList.innerHTML += `
                    <div class="border border-${file.color}-200 rounded-lg p-4 bg-${file.color}-50">
                        <div class="flex items-center mb-3">${iconPath}<span class="font-medium text-${file.color}-800 ml-2">${getFileTypeLabel(file.type)}</span></div>
                        <p class="text-sm text-gray-700 mb-3 break-all">${file.name}</p>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="downloadFile(${index})" class="col-span-1 px-3 py-2 bg-${file.color}-600 text-white text-xs rounded">Download</button>
                            <button onclick="previewFile(${index})" class="col-span-1 px-3 py-2 bg-gray-200 text-xs rounded">Anteprima</button>
                            <button onclick="copyFileContent(${index}, this)" class="col-span-1 px-3 py-2 bg-gray-200 text-xs rounded">Copia</button>
                        </div>
                    </div>`;
            });
            if (generatedFilesData.length > 0) previewFile(0);
        }

        function getIconPath(iconType) {
            const icons = {
                'document': `<svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'document-text': `<svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>`,
                'table': `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0V4a1 1 0 011-1h12a1 1 0 011 1v16a1 1 0 01-1-1H4a1 1 0 01-1-1z"></path></svg>`
            };
            return icons[iconType] || icons['document'];
        }

        function getFileTypeLabel(type) {
            return { 'offer': 'Offerta Commerciale', 'summary': 'Sintesi Progetto', 'crm': 'Dati CRM' }[type] || type;
        }

        function downloadFile(index) {
            const file = generatedFilesData[index];
            let blob;
            if (file.type === 'crm') {
                const ws = XLSX.utils.json_to_sheet([JSON.parse(file.content)]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "CRM_Data");
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            } else {
                blob = new Blob([file.content], { type: 'text/html' });
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = file.name; a.click();
            URL.revokeObjectURL(url);
        }

        function copyFileContent(index, buttonElement) {
             const file = generatedFilesData[index];
            const originalText = buttonElement.textContent;
            let copyPromise;
            if (file.type === 'offer' || file.type === 'summary') {
                const blob = new Blob([file.content], { type: 'text/html' });
                const item = new ClipboardItem({ 'text/html': blob });
                copyPromise = navigator.clipboard.write([item]);
            } else {
                copyPromise = navigator.clipboard.writeText(file.content);
            }
            copyPromise.then(() => {
                buttonElement.textContent = 'Copiato!';
                setTimeout(() => { buttonElement.textContent = originalText; }, 2000);
            }).catch(err => { alert('Errore: ' + err.message); });
        }
        
        function previewFile(index) {
            const file = generatedFilesData[index];
            const previewContainer = document.getElementById('filesPreview');
            let previewHTML = `<div class="bg-white border rounded-lg p-6"><div class="flex justify-between items-center mb-4"><h4 class="font-medium text-gray-800">Anteprima: ${file.name}</h4><button onclick="downloadFile(${index})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded">Scarica</button></div><div class="bg-gray-50 p-4 rounded max-h-96 overflow-y-auto border">`;
            if (file.type === 'crm') {
                previewHTML += `<pre class="text-sm font-mono">${JSON.stringify(JSON.parse(file.content), null, 2)}</pre>`;
            } else {
                previewHTML += `<iframe srcdoc="${file.content.replace(/"/g, '"')}" style="width:100%; height:350px; border:none;"></iframe>`;
            }
            previewHTML += `</div></div>`;
            previewContainer.innerHTML = previewHTML;
        }

        function downloadAllFiles() {
            generatedFilesData.forEach((file, index) => setTimeout(() => downloadFile(index), index * 300));
        }

        function resetFileGenerator() {
            document.getElementById('fileGeneratorForm').reset();
            removeAnalysisFile();
            generatedFilesData = [];
            document.getElementById('fileGeneratorForm').classList.remove('hidden');
            document.getElementById('generatedFiles').classList.add('hidden');
             const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('offerExpiry').value = tomorrow.toISOString().split('T')[0];
        }

        document.addEventListener('DOMContentLoaded', function() {
            showIntro();
            document.getElementById('homeBtn').addEventListener('click', showIntro);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('offerExpiry').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('fileGenerateBtn').disabled = true;
        });
    </script>
</body>
</html>
