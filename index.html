<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimedia & Workspaces Strategist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .loading { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">
                    Multimedia & Workspaces Strategist AI
                </h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">
                    Il tuo partner strategico per spazi di collaborazione perfetti
                </p>
            </div>
            <button id="homeBtn" class="text-sm font-medium text-blue-600 hover:text-blue-800 hidden">
                Torna alla Homepage
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">
        <!-- Intro Section -->
        <div id="introSection" class="bg-white rounded-xl shadow-lg p-8">
            <div class="flex items-start mb-6">
                <svg class="w-12 h-12 text-blue-600 mt-1 mr-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                <div class="w-full">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Scegli il tuo modulo</h2>
                    <p class="text-lg text-gray-700 mb-8">Seleziona lo strumento che ti serve per il tuo progetto</p>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Module 1 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-blue-300 transition-all">
                            <svg class="w-10 h-10 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Analizza Meeting & Genera Brief DSA</h3>
                            <p class="text-gray-600 mb-4">Analizza appunti del meeting, estrai requisiti e genera brief strutturato per il team DSA.</p>
                            <button onclick="showPostMeeting()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg">
                                Inizia
                            </button>
                        </div>

                        <!-- Module 2 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-cyan-300 transition-all">
                            <svg class="w-10 h-10 text-cyan-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Wizard Spazi Collaborativi</h3>
                            <p class="text-gray-600 mb-4">Definisci la soluzione tecnologica ottimale per spazi collaborativi basandoti su misure, tipologia e caratteristiche.</p>
                            <button onclick="showSpaceWizard()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-cyan-600 hover:bg-cyan-700 text-white font-medium rounded-lg">
                                Inizia
                            </button>
                        </div>

                        <!-- Module 3 -->
                        <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md hover:border-green-300 transition-all">
                            <svg class="w-10 h-10 text-green-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Generazione File</h3>
                            <p class="text-gray-600 mb-4">Trasforma l'Analisi Economica DSA in offerta commerciale, sintesi dati e file CRM pronti all'uso.</p>
                            <button onclick="showFileGenerator()" class="w-full inline-flex items-center justify-center px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg">
                                Inizia
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Post Meeting Module -->
        <div id="postMeetingSection" class="hidden">
            <!-- Content for module 1 -->
        </div>

        <!-- Space Wizard Module -->
        <div id="spaceWizardSection" class="hidden">
             <!-- Content for module 2 -->
        </div>

        <!-- File Generator Module -->
        <div id="fileGeneratorSection" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <button onclick="showIntro()" class="inline-flex items-center mb-6 px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    Torna alla Homepage
                </button>

                <h2 class="text-3xl font-bold text-gray-900 mb-2">Generazione File da Analisi Economica DSA</h2>
                <p class="text-gray-600 mb-8">Carica il file Excel "Analisi Economica" e genera automaticamente i documenti necessari.</p>

                <form id="fileGeneratorForm" class="space-y-8">
                    <!-- Form fields -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Cliente *</label>
                            <input type="text" id="fileGenClientName" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Codice Progetto</label>
                            <input type="text" id="projectCode" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sales Manager</label>
                            <input type="text" id="salesManager" class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File Analisi Economica DSA *</label>
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <div onclick="document.getElementById('analysisUpload').click()" class="flex flex-col items-center justify-center h-32 border-2 border-green-300 border-dashed rounded-lg cursor-pointer">
                                <span class="text-sm text-green-700 font-medium">Carica File</span>
                                <span class="text-xs text-green-600 mt-1">.xlsx, .xlsm, .xls</span>
                            </div>
                            <input type="file" id="analysisUpload" class="hidden" accept=".xlsx,.xlsm,.xls" onchange="handleAnalysisUpload(event)">
                            <div id="uploadedAnalysisFile" class="mt-4 hidden">
                                <div class="flex items-center justify-between bg-green-100 p-3 rounded-lg">
                                    <span id="analysisFileName" class="font-medium text-green-800"></span>
                                    <button type="button" onclick="removeAnalysisFile()" class="text-red-500">Rimuovi</button>
                                </div>
                            </div>
                            <div id="excelDataPreview" class="mt-4 hidden">
                                <h4 class="font-medium text-gray-800 mb-2">Anteprima Dati</h4>
                                <div id="excelPreviewContent" class="text-sm text-gray-700 bg-white p-4 rounded-lg border max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">File da Generare</label>
                        <div class="grid md:grid-cols-3 gap-4">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer"><input type="checkbox" id="generateOffer" class="mr-3" checked> Offerta Commerciale</label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer"><input type="checkbox" id="generateSummary" class="mr-3" checked> Sintesi Dati</label>
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer"><input type="checkbox" id="generateCRM" class="mr-3" checked> File CRM</label>
                        </div>
                    </div>
                     <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-4">Personalizzazione</h4>
                         <div class="grid md:grid-cols-2 gap-6">
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Note Commerciali</label><textarea id="commercialNotes" rows="4" class="w-full p-3 border rounded-lg"></textarea></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-2">Contatti Cliente</label><textarea id="clientContacts" rows="4" class="w-full p-3 border rounded-lg"></textarea></div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4 mt-4">
                            <div><label class="block text-sm">Scadenza Offerta</label><input type="date" id="offerExpiry" class="w-full p-3 border rounded-lg"></div>
                            <div><label class="block text-sm">Pagamento</label><input type="text" id="paymentTerms" class="w-full p-3 border rounded-lg" value="Da concordare"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="button" onclick="generateFiles()" id="fileGenerateBtn" class="px-8 py-3 bg-green-600 text-white font-medium rounded-lg disabled:opacity-50" disabled>Genera File</button>
                    </div>
                </form>

                <div id="generatedFiles" class="hidden space-y-6 mt-8">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">File Generati</h3>
                        <button type="button" onclick="resetFileGenerator()" class="px-4 py-2 bg-gray-200 rounded-lg">Nuova Generazione</button>
                    </div>
                    <div id="filesList" class="grid md:grid-cols-3 gap-6"></div>
                    <div id="filesPreview" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let analysisFile = null;
        let extractedData = {};
        let generatedFilesData = [];

        // Navigation functions
        function showIntro() {
            document.getElementById('introSection').classList.remove('hidden');
            document.getElementById('fileGeneratorSection').classList.add('hidden');
            document.getElementById('homeBtn').classList.add('hidden');
        }

        function showFileGenerator() {
            document.getElementById('introSection').classList.add('hidden');
            document.getElementById('fileGeneratorSection').classList.remove('hidden');
            document.getElementById('homeBtn').classList.remove('hidden');
        }

        // --- FILE GENERATOR LOGIC ---
        async function handleAnalysisUpload(event) {
            analysisFile = event.target.files[0];
            if (!analysisFile) return;
            document.getElementById('analysisFileName').textContent = analysisFile.name;
            document.getElementById('uploadedAnalysisFile').classList.remove('hidden');
            try {
                const data = await readExcelFile(analysisFile);
                extractedData = extractKeyData(data);
                displayExcelPreview(extractedData);
                document.getElementById('fileGenerateBtn').disabled = false;
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        resolve(XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' }));
                    } catch (err) { reject(err); }
                };
                reader.readAsBinaryString(file);
            });
        }

        function extractKeyData(sheetData) {
            const extracted = { articoli: [] };
            const colonne = {
                codiceProduttore_I: 8,
                valore_J: 9,
                quantita_K: 10,
                venditaUnitario_T: 19,
                venditaTotale_U: 20,
                margine_P: 15,
            };
            for (let i = 2; i < sheetData.length; i++) {
                const row = sheetData[i];
                if (row && row[colonne.valore_J]) {
                    extracted.articoli.push({
                        codiceProduttoreI: row[colonne.codiceProduttore_I] || '',
                        valoreJ: row[colonne.valore_J] || '',
                        quantitaK: parseFloat(row[colonne.quantita_K]) || 0,
                        venditaUnitarioT: parseFloat(row[colonne.venditaUnitario_T]) || 0,
                        venditaTotaleU: parseFloat(row[colonne.venditaTotale_U]) || 0,
                        margine: parseFloat(row[colonne.margine_P]) || 0,
                    });
                }
            }
            extracted.totaleVenditaU = extracted.articoli.reduce((sum, art) => sum + art.venditaTotaleU, 0);
            return extracted;
        }

        function displayExcelPreview(data) {
            const previewContainer = document.getElementById('excelPreviewContent');
            let html = `Totale Offerta: <strong>€${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong><br>Articoli: <strong>${data.articoli.length}</strong>`;
            previewContainer.innerHTML = html;
            document.getElementById('excelDataPreview').classList.remove('hidden');
        }

        function removeAnalysisFile() {
            analysisFile = null;
            extractedData = {};
            document.getElementById('analysisUpload').value = '';
            document.getElementById('uploadedAnalysisFile').classList.add('hidden');
            document.getElementById('excelDataPreview').classList.add('hidden');
            document.getElementById('fileGenerateBtn').disabled = true;
        }

        async function generateFiles() {
            const btn = document.getElementById('fileGenerateBtn');
            btn.disabled = true;
            btn.textContent = 'Generazione...';

            const projectData = {
                cliente: document.getElementById('fileGenClientName').value,
                projectCode: document.getElementById('projectCode').value,
                salesManager: document.getElementById('salesManager').value,
                commercialNotes: document.getElementById('commercialNotes').value,
                offerExpiry: document.getElementById('offerExpiry').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                extractedData: extractedData
            };

            generatedFilesData = [];
            if (document.getElementById('generateOffer').checked) {
                generatedFilesData.push({ type: 'offer', name: `Offerta_${projectData.cliente}.docx`, content: generateCommercialOffer(projectData) });
            }
            if (document.getElementById('generateSummary').checked) {
                generatedFilesData.push({ type: 'summary', name: `Sintesi_${projectData.cliente}.pdf`, content: generateExecutiveSummary(projectData) });
            }
            if (document.getElementById('generateCRM').checked) {
                generatedFilesData.push({ type: 'crm', name: `CRM_${projectData.cliente}.xlsx`, content: generateCRMFile(projectData) });
            }

            displayGeneratedFiles();
            document.getElementById('fileGeneratorForm').classList.add('hidden');
            document.getElementById('generatedFiles').classList.remove('hidden');
            btn.disabled = false;
            btn.textContent = 'Genera File';
        }

        // *** MODIFIED FUNCTION (Description I+J) ***
        function generateCommercialOffer(projectData) {
            const data = projectData.extractedData;
            return `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;margin:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;text-align:left;}th{background-color:#f2f2f2;}.amount{text-align:right;}</style></head><body>
            <h1>Offerta Commerciale</h1><p><strong>Cliente:</strong> ${projectData.cliente}</p>
            <table><thead><tr><th>Q.tà</th><th>Descrizione</th><th>Prezzo Unitario</th><th>Prezzo Totale</th></tr></thead>
            <tbody>
                ${data.articoli.map(art => `
                <tr>
                    <td>${art.quantitaK}</td>
                    <td>${art.codiceProduttoreI} - ${art.valoreJ}</td>
                    <td class="amount">€ ${art.venditaUnitarioT.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                    <td class="amount">€ ${art.venditaTotaleU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</td>
                </tr>`).join('')}
                <tr><td colspan="3" class="amount"><strong>TOTALE</strong></td><td class="amount"><strong>€ ${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong></td></tr>
            </tbody></table></body></html>`;
        }
        
        // *** RESTORED FUNCTION ***
        function generateExecutiveSummary(projectData) {
            const data = projectData.extractedData;
            return `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;margin:20px;}</style></head><body>
            <h1>Sintesi Progetto</h1><p><strong>Cliente:</strong> ${projectData.cliente}</p>
            <p><strong>Valore Totale:</strong> € ${data.totaleVenditaU.toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
            <h3>Dettaglio Articoli</h3>
            <ul>${data.articoli.map(art => `<li>${art.quantitaK}x ${art.codiceProduttoreI} - ${art.valoreJ}</li>`).join('')}</ul>
            </body></html>`;
        }

        // *** RESTORED FUNCTION ***
        function generateCRMFile(projectData) {
            const data = projectData.extractedData;
            const crmData = {
                Cliente: projectData.cliente,
                Codice_Progetto: projectData.projectCode,
                Sales_Manager: projectData.salesManager,
                Valore_Offerta: data.totaleVenditaU,
                Data_Scadenza: projectData.offerExpiry,
                Termini_Pagamento: projectData.paymentTerms,
                Note: projectData.commercialNotes,
                Numero_Articoli: data.articoli.length
            };
            return JSON.stringify(crmData, null, 2);
        }

        function displayGeneratedFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            generatedFilesData.forEach((file, index) => {
                filesList.innerHTML += `
                <div class="border p-4 rounded-lg">
                    <p class="font-medium">${file.name}</p>
                    <div class="flex gap-2 mt-2">
                        <button onclick="downloadFile(${index})" class="text-xs bg-blue-500 text-white px-2 py-1 rounded">Download</button>
                        <button onclick="previewFile(${index})" class="text-xs bg-gray-200 px-2 py-1 rounded">Anteprima</button>
                        <button onclick="copyFileContent(${index}, this)" class="text-xs bg-gray-200 px-2 py-1 rounded">Copia</button>
                    </div>
                </div>`;
            });
            if (generatedFilesData.length > 0) previewFile(0);
        }

        function downloadFile(index) {
            const file = generatedFilesData[index];
            let blob;
            if (file.type === 'crm') {
                const ws = XLSX.utils.json_to_sheet([JSON.parse(file.content)]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "CRM_Data");
                const buffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                blob = new Blob([buffer], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
            } else {
                blob = new Blob([file.content], {type: 'text/html'});
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            a.click();
            URL.revokeObjectURL(url);
        }

        // *** MODIFIED FUNCTION (Rich Text Copy) ***
        function copyFileContent(index, buttonElement) {
            const file = generatedFilesData[index];
            const originalText = buttonElement.textContent;
            let copyPromise;

            if (file.type === 'offer' || file.type === 'summary') {
                // Copy as Rich Text (HTML) for Word/Docs
                const blob = new Blob([file.content], { type: 'text/html' });
                const item = new ClipboardItem({ 'text/html': blob });
                copyPromise = navigator.clipboard.write([item]);
            } else {
                // Copy as plain text for CRM data
                copyPromise = navigator.clipboard.writeText(file.content);
            }

            copyPromise.then(() => {
                buttonElement.textContent = 'Copiato!';
                setTimeout(() => { buttonElement.textContent = originalText; }, 2000);
            }).catch(err => {
                alert('Errore nella copia: ' + err.message);
            });
        }
        
        function previewFile(index) {
            const file = generatedFilesData[index];
            const previewContainer = document.getElementById('filesPreview');
            previewContainer.innerHTML = `
            <div class="border p-6 rounded-lg">
                <h4 class="font-medium">Anteprima: ${file.name}</h4>
                <div class="bg-gray-50 p-4 mt-2 rounded max-h-96 overflow-y-auto border">
                ${file.type === 'crm' ? `<pre>${file.content}</pre>` : `<iframe srcdoc="${file.content.replace(/"/g, '"')}" style="width:100%; height:300px; border:none;"></iframe>`}
                </div>
            </div>`;
        }

        function resetFileGenerator() {
            document.getElementById('fileGeneratorForm').reset();
            removeAnalysisFile();
            generatedFilesData = [];
            document.getElementById('generatedFiles').classList.add('hidden');
            document.getElementById('fileGeneratorForm').classList.remove('hidden');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showIntro();
            document.getElementById('homeBtn').addEventListener('click', showIntro);
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('offerExpiry').valueAsDate = tomorrow;
        });
    </script>
</body>
</html>
